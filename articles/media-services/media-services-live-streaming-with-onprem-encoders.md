<properties 
	pageTitle="マルチビットレートのストリームを作成するオンプレミス エンコーダーを使用したライブ ストリーミング | Microsoft Azure" 
	description="このトピックでは、内部設置型のエンコーダーからマルチビットレートのライブ ストリームを受信するチャネルの設定方法について説明します。次にストリームは、1 つ以上のストリーミング エンドポイントを介して、HLS、スムーズ ストリーミング、MPEG DASH、HDS のいずれかを使用してクライアントの再生アプリケーションに送信できます。" 
	services="media-services" 
	documentationCenter="" 
	authors="Juliako" 
	manager="erikre" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.workload="media" 
	ms.tgt_pltfrm="na" 
	ms.devlang="ne" 
	ms.topic="article" 
	ms.date="09/19/2016" 
	ms.author="cenkdin;juliako"/>

#オンプレミスのエンコーダーからマルチ ビットレートのライブ ストリームを受信するチャネルを操作する

##Overview

Azure Media Services では、**チャネル**は、ライブ ストリーミング コンテンツを処理するためのパイプラインを表します。**チャネル**は、次の 2 つの方法のいずれかでライブ入力ストリームを受信します。


- オンプレミスのライブ エンコーダーは、マルチビットレート **RTMP** または**スムーズ ストリーミング** (Fragmented MP4) を、AMS によるライブ エンコードの実行が無効なチャネルに送信します。取り込んだストリームは、追加の処理なしで**チャネル**を通過します。この方式は、**パススルー**と呼ばれます。マルチ ビットレートのスムーズ ストリーミングを出力するライブ エンコーダーとして、Elemental、Envivio、Cisco を使用できます。Adobe Flash Live、Telestream Wirecast、Tricaster トランスコーダーは、RTMP を出力するライブ エンコーダーです。ライブ エンコーダーは、ライブ エンコードが有効になっていないチャネルにシングル ビットレート ストリームも送信できますが、これはお勧めしません。Media Services は、要求に応じて、ストリームを顧客に配信します。

	>[AZURE.NOTE] パススルー方式を使用することが、ライブ ストリーミングを行う最も経済的な方法です。
	
- オンプレミスのライブ エンコーダーは、RTP (MPEG-TS)、RTMP、スムーズ ストリーミング (Fragmented MP4) のいずれかの形式で、シングル ビットレート ストリームを Media Services による Live Encoding が有効なチャネルに送信します。次に、受信したシングル ビットレート ストリームのマルチ ビットレート (アダプティブ) ビデオ ストリームへのライブ エンコードがチャネルで実行されます。Media Services は、要求に応じて、ストリームを顧客に配信します。

Media Services 2.10 リリース以降、チャネルを作成するときに、チャネルで入力ストリームを受信する方法、およびチャネルでストリームのライブ エンコードを実行するかどうかを指定できます。2 つのオプションがあります。

- **なし** – オンプレミスのライブ エンコーダーを使用してマルチビットレート ストリーム (パススルー ストリーム) を出力する場合には、この値を指定します。この場合は、受信ストリームはエンコードなしで出力に渡されます。これは、2.10 リリースより前のチャネル動作です。このトピックでは、この種類のチャネルの操作について詳しく説明します。

- **Standard** – Media Services を使用して、シングル ビットレートのライブ ストリームをマルチ ビットレート ストリームにエンコードする場合に、この値を選択します。ライブ エンコードは課金に影響することと、ライブ エンコード チャネルを "実行中" 状態のままにしておくと請求料金が課されることに注意してください。余分な時間料金を課されないようにするために、ライブ ストリーミング イベントが完了したら、チャネルの実行をすぐに停止することをお勧めします。Media Services は、要求に応じて、ストリームを顧客に配信します。

>[AZURE.NOTE]このトピックでは、ライブ エンコードの実行が無効なチャネル (エンコードの種類が**なし**のチャネル) の属性について説明します。ライブ エンコードの実行が有効なチャネルの操作については、「[Azure Media Services を使用して Live Encoding の実行が有効なチャネルを操作する](media-services-manage-live-encoder-enabled-channels.md)」をご覧ください。

次の図は、オンプレミスのライブのエンコーダーを使用してマルチビットレートの RTMP や Fragmented MP4 (スムーズ ストリーミング) ストリームを出力するライブ ストリーミング ワークフローを表しています。

![ライブ ワークフロー][live-overview]

このトピックでは、以下の内容を説明します。

- [一般的なライブ ストリーミング シナリオ](media-services-live-streaming-with-onprem-encoders.md#scenario)
- [チャネルとその関連コンポーネントの説明](media-services-live-streaming-with-onprem-encoders.md#channel)
- [考慮事項](media-services-live-streaming-with-onprem-encoders.md#considerations)

##<a id="scenario"></a>一般的なライブ ストリーミング シナリオ
次の手順では、一般的なライブ ストリーミング アプリケーションの作成に関連するタスクを示します。

1. ビデオ カメラをコンピューターに接続します。複数ビットレ0ートの RTMP や Fragmented MP4 (スムーズ ストリーミング) ストリームを出力するオンプレミスのライブ エンコーダーを起動して構成します。詳しくは、「[Azure Media Services RTMP サポートおよびライブ エンコーダー](http://go.microsoft.com/fwlink/?LinkId=532824)」をご覧ください。
	
	この手順は、チャネルを作成した後でも実行できます。

1. チャネルを作成し、起動します。
1. チャネルの取り込み URL を取得します。

	取り込み URL は、ライブ エンコーダーがチャネルにストリームを送信する際に使用されます。
1. チャネルのプレビュー URL を取得します。

	この URL を使用して、チャネルがライブ ストリームを正常に受信できることを確認します。

3. プログラムを作成します。

	Azure クラシック ポータルを使用する場合、プログラムを作成すると資産も作成されます。

	.NET SDK または REST を使用する場合は、プログラムを作成するときに資産を作成し、その資産を使用するように指定する必要があります。
1. プログラムに関連付けられた資産を発行します。

	コンテンツをストリームするストリーミング エンドポイントに少なくとも 1 つのストリーミング予約ユニットがあることを確認します。
1. ストリーミングとアーカイブの開始を準備するときにプログラムを開始します。
2. 必要に応じて、ライブ エンコーダーは、広告の開始を信号通知できます。広告が出力ストリームに挿入されます。
1. イベントのストリーミングとアーカイブを停止するときにプログラムを停止します。
1. プログラムを削除し、資産を削除 (オプション) します。

##<a id="channel"></a>チャネルとその関連コンポーネントの説明

###<a id="channel_input"></a>チャネル入力 (取り込み) の構成

####<a id="ingest_protocols"></a>取り込みストリーミング プロトコル

Media Services は、次のストリーミング プロトコルを使用したライブのフィードのインジェストをサポートしています。

- **マルチビットレートの Fragmented MP4**
 
- **マルチビットレートの RTMP**

	**RTMP** のインジェスト ストリーミング プロトコルが選択されている場合、そのチャンネルに 2 つのインジェスト (入力) エンドポイントが作成されます。
	
	**プライマリ URL**: チャネルのプライマリ RTMP インジェスト エンドポイントの完全修飾 URL を指定します。

	**セカンダリ URL**: チャネルのセカンダリ RTMP インジェスト エンドポイントの完全修飾 URL を指定します。


	特に次のようなシナリオで、インジェスト ストリームの持続性とフォールト トレランスや、エンコーダーのフェールオーバーとフォールト トレランスを向上させるには、セカンダリ URL を使用します。

	- 1 つのエンコーダーがプライマリとセカンダリの両方の URL に二重にプッシュする
	
		この主な目的は、ネットワークの変動やジッターに複数の回復性を提供することです。一部の RTMP エンコーダーでは、ネットワーク切断を正しく処理できません。ネットワーク切断が発生すると、エンコーダーはエンコードを停止し、再接続されたときにバッファー内のデータを送信しないため、不連続性とデータ損失が発生します。ネットワーク切断は、Azure 側のネットワークやメンテナンスが不適切なために発生する場合があります。プライマリ/セカンダリ URL は、ネットワークの問題を軽減し、制御されたアップグレード プロセスも提供します。スケジュールされたネットワーク切断が発生するたびに、Media Services はプライマリとセカンダリの切断を管理し、2 つの間の切断を遅延させることで、エンコーダーがデータを送信し続け、再接続する時間を提供します。切断の順序はランダムにできますが、プライマリ/セカンダリまたはセカンダリ/プライマリ間には常に遅延が発生します。このシナリオでは、エンコーダーは単一障害点になっています。
	 
	- 複数のエンコーダの各エンコーダーが専用のポイントにプッシュする
		
		このシナリオは、両方のエンコーダーと取り込みの冗長性を提供します。このシナリオでは、encoder1 がプライマリ URL にプッシュし、encoder2 がセカンダリ URL にプッシュします。1 つのエンコーダーでエラーが発生しても、他のエンコーダーでデータを送信し続けることができます。Media Services はプライマリとセカンダリを同時に切断しないため、データの冗長性は維持されます。このシナリオでは、エンコーダーは時間を同期し、全く同じデータを提供するものとします。
 
	- 複数のエンコーダーがプライマリとセカンダリの両方の URL に二重にプッシュする
	
		このシナリオでは、両方のエンコーダーがプライマリとセカンダリの両方の URL にデータをプッシュします。これは、データの冗長性だけでなく、最高の信頼性とフォールト トレランスを提供します。両方のエンコーダーの障害に対応でき、1 つのエンコーダーが動作しなくなった場合でも切断できます。このシナリオでは、エンコーダーは時間を同期し、全く同じデータを提供するものとします。

RTMP ライブ エンコーダーの詳細については、「[Azure Media Services の RTMP サポートとライブ エンコーダー (ブログの投稿)](http://go.microsoft.com/fwlink/?LinkId=532824)」をご覧ください。

次の考慮事項が適用されます。

- 取り込みポイントにデータを送信するための十分な空きのインターネット接続があるかどうかを確認します。
- セカンダリの取り込み URL を使用する際は、追加の帯域幅が必要です。
- 受信するマルチビットレート ストリームには、最大 10 のビデオ品質レベル (層) と、最大 5 つのオーディオ トラックを含めることができます。
- ビデオ品質レベル (層) の最高の平均ビットレートは、10 Mbps 以下である必要があります。
- すべてのビデオとオーディオ ストリームの平均ビットレートの合計は、25 Mbps である必要があります。
- チャネルやチャネルに関連付けられたプログラムの実行中は、入力プロトコルを変更できません。別のプロトコルが必要な場合は、入力プロトコルごとに別のチャネルを作成します。
- チャネルに単一ビットレートを取り込むことはできますが、ストリームはチャネルで処理されないため、クライアント アプリケーションも単一ビットレートのストリームを受信することになります (このオプションはお勧めしません)。

####取り込み URL (エンドポイント) 

チャネルは、ライブ エンコーダーで指定した入力エンドポイント (取り込み URL) を提供するため、エンコーダーはご使用のチャネルにストリームをプッシュできます。

取り込み URL は、チャネルの作成時に取得できます。これらの URL を取得するために、チャネルが**実行中**状態である必要はありません。データをチャネルにプッシュする準備ができたら、チャネルを**実行中**状態にする必要があります。チャネルがデータの取り込みを開始すると、プレビュー URL 経由でストリームをプレビューできます。

Fragmented MP4 (スムーズ ストリーミング) のライブ ストリームを、SSL 接続で取り込むこともできます。SSL 経由で取り込むには、取り込み URL を HTTPS に更新する必要があります。現時点では、SSL 経由で RTMP を取り込むことはできません。

####<a id="keyframe_interval"></a>キーフレームの間隔

オンプレミスのライブ エンコーダーを使用してマルチビットレートのストリームを生成する場合、キーフレームの間隔は GOP 期間を指定します (その外部エンコーダーで使用)。チャネルがこの受信ストリームを受信したら、スムーズ ストリーミング、DASH、HLS のいずれかの形式でライブ ストリームをクライアントの再生アプリケーションに配信できます。ライブ ストリーミングの実行中、HLS は常に動的にパッケージ化されます。既定では、Media Services は自動的に HLS セグメントのパッケージ率 (セグメントあたりのフラグメント) をキーフレームの間隔に基づいて計算します。これは、画像グループ (GOP) とも呼ばれ、ライブ エンコーダーから受信します。

次の表は、セグメントの期間の計算方法を示しています。

キーフレームの間隔|HLS セグメントのパッケージ率 (FragmentsPerSegment)|例
---|---|---
3 秒以下|3:1|KeyFrameInterval (または GOP) が 2 秒の場合、既定の HLS セグメントのパッケージ率は 3:1 になり、6 秒間の HLS セグメントが作成されます。
3～5 秒|2:1|KeyFrameInterval (または GOP) が 4 秒の場合、既定の HLS セグメントのパッケージ率は 2:1 になり、8 秒間の HLS セグメントが作成されます。
6 秒以上|1:1|KeyFrameInterval (または GOP) が 6 秒の場合、既定の HLS セグメントのパッケージ率は 1:1 になり、6 秒間の HLS セグメントが作成されます。


セグメントあたりのフラグメント率は、チャネルの出力を構成して ChannelOutputHls の FragmentsPerSegment を設定すると変更できます。

また、キーフレームの間隔の値は、ChanneInput の KeyFrameInterval プロパティを設定すると変更できます。

KeyFrameInterval を明示的に設定すると、HLS セグメントのパッケージ率 FragmentsPerSegment は、上記の規則を使用して計算されます。

KeyFrameInterval と FragmentsPerSegment の両方を明示的に設定すると、Media Services は設定された値を使用します。


####許可された IP アドレス

このチャネルにビデオを発行できる IP アドレスを定義できます。許可された IP アドレスは、1 つの IP アドレス (例: '10.0.0.1')、IP アドレスと CIDR のサブネットを使用した IP 範囲 (例: ‘10.0.0.1/22’)、または IP アドレスとピリオド区切りのサブネット マスクを使用した IP 範囲 (例: ‘10.0.0.1(255.255.252.0)’) のいずれかの形式で指定できます。

IP アドレスが指定されておらず、規則の定義もない場合は、どの IP アドレスも許可されません。すべての IP アドレスを許可するには、規則を作成し、0.0.0.0/0 に設定します。

###チャネルのプレビュー 

####プレビュー URL

ストリームをさらに処理して配信する前にプレビューできるプレビュー エンドポイント (プレビュー URL) がチャネルから提供されます。

プレビュー URL は、チャネルの作成時に取得できます。URL を取得するために、チャネルが**実行中**状態である必要はありません。

チャネルがデータの取り込みを開始した後、ストリームをプレビューできます。

現在、プレビュー ストリームを配信できるのは指定された入力タイプにかかわらず、Fragmented MP4 (スムーズ ストリーミング) 形式のみです。スムーズ ストリーミングのテストには、[http://smf.cloudapp.net/healthmonitor](http://smf.cloudapp.net/healthmonitor) プレーヤーを使用できます。また、Azure クラシック ポータルでホストされているプレーヤーを使用してストリームを表示することもできます。


####許可された IP アドレス

プレビューのエンドポイントへの接続を許可する IP アドレスを定義できます。IP アドレスを指定しない場合、すべての IP アドレスが許可されます。許可された IP アドレスは、1 つの IP アドレス (例: '10.0.0.1')、IP アドレスと CIDR のサブネットを使用した IP 範囲 (例: ‘10.0.0.1/22’)、または IP アドレスとピリオド区切りのサブネット マスクを使用した IP 範囲 (例: ‘10.0.0.1(255.255.252.0)’) のいずれかの形式で指定できます。

###チャネルの出力

詳細については、[キーフレームの間隔](#keyframe_interval)セクションをご覧ください。


###チャネルのプログラム

チャネルは、ライブ ストリームのセグメントの発行と保存を管理できるプログラムに関連付けられています。プログラムはチャネルによって管理されます。チャネルとプログラムの関係は、従来のメディアとよく似ています。チャネルが絶えずコンテンツのストリームを配信するのに対し、プログラムは、そのチャネル上で決まった時間に生じるイベントです。

プログラムの**アーカイブ ウィンドウ**の長さを設定することで、録画されたコンテンツの保持時間を指定できます。この値は、最小 5 分から最大 25 時間までの範囲で設定できます。クライアントが現在のライブ位置からさかのぼって検索できる最長時間も、Archive Window (アーカイブ ウィンドウ)の長さによって決まります。プログラムの放送は、指定された期間継続しますが、ArchiveWindowLength を過ぎたコンテンツは絶えず破棄されていきます。さらに、このプロパティの値によって、クライアント マニフェストが肥大した場合の最大サイズも決まります。

各プログラムは、ストリーミングされたコンテンツを格納する資産に関連付けられます。資産は Azure ストレージ アカウント内の BLOB コンテナーにマップされ、資産内のファイルは BLOB としてそのコンテナーに格納されます。プログラムを発行して顧客がストリームを表示できるようにするには、関連付けられた資産の OnDemand ロケーターを作成する必要があります。このロケーターを作成すると、ストリーミング URL を構築してクライアントに提供できます。

チャネルは、最大 3 つの同時実行プログラムをサポートするため、同じ受信ストリームのアーカイブを複数作成できます。これにより、1 つのイベントのさまざまな部分を必要に応じて発行したりアーカイブしたりできます。たとえば、ビジネス要件によって 1 つのプログラムの 6 時間分をアーカイブする一方、最後の 10 分間のみをブロードキャストする場合があります。これを実現するには、2 つの同時実行プログラムを作成する必要があります。1 つのプログラムは 6 時間分のイベントをアーカイブするように設定しますが、プログラムは発行されません。もう 1 つのプログラムは 10 分間のアーカイブを行うように設定します。このプログラムは発行されます。

新しいイベントには既存のプログラムを再使用できません。代わりに、「ライブ ストリーミング アプリケーションのプログラミング」セクションにあるように、各イベントで新しいプログラムを作成し、起動します。

ストリーミングとアーカイブの開始を準備するときにプログラムを開始します。イベントのストリーミングとアーカイブを停止するときにプログラムを停止します。

アーカイブ済みコンテンツを削除するには、プログラムを停止して削除し、次に関連付けられた資産を削除します。プログラムが資産を使用している場合は資産を削除できません。まずプログラムを削除する必要があります。

プログラムを停止して削除した後も、資産を削除していなければアーカイブ済みコンテンツをオンデマンドでのビデオとしてストリームできます。

アーカイブ済みコンテンツを保持したいが、ストリーミングには使用したくない場合は、ストリーミング ロケーターを削除します。

##<a id="states"></a>チャネルの状態と課金モードとの対応 

現在のチャネルの状態。指定できる値は、次のとおりです。

- **停止済み**。これは、チャネル作成後の初期状態です。この状態で、チャネルのプロパティを更新できますが、ストリーミングは許可されていません。
- **開始中**。チャネルを開始しています。この状態の場合、更新やストリーミングはできません。エラーが発生した場合は、チャネルは Stopped 状態に戻ります。
- **実行中**。チャネルは、ライブ ストリームを処理できます。
- **停止中**。チャネルを停止しています。この状態の場合、更新やストリーミングはできません。
- **削除中**。チャネルが削除されました。この状態の場合、更新やストリーミングはできません。

次の表は、チャネルの状態と課金モードとの対応を示しています。
 
チャネルの状態|ポータル UI インジケーター|課金対象
---|---|---|---
Starting|Starting|いいえ (遷移状態)
実行中|準備完了 (実行中プログラムなし)<p>または<p>ストリーミング (実行中プログラムが最低 1 つ存在)|はい
停止中|停止中|いいえ (遷移状態)
停止済み|停止済み|なし

##<a id="cc_and_ads"></a>クローズド キャプションと広告の挿入 

次の表は、サポートされているクローズド キャプションや広告挿入の標準を示しています。

Standard|メモ
---|---
CEA-708 と EIA-608 (708/608)|CEA 708 と EIA 608 は、米国とカナダのクローズド キャプションの標準です。<p><p>現時点では、キャプションがサポートされるのはエンコードされた入力ストリーム内でのみです。608 または 708 キャプションを、Media Services に送信されるエンコードされたストリームに挿入できるライブ Media Encoder を使用する必要があります。Media Services はキャプションが挿入されたコンテンツをユーザーに配信します。
ismt (スムーズ ストリーミング テキスト トラック) 内の TTML|Media Services の動的パッケージ機能では、クライアントが MPEG DASH、HLS、スムーズ ストリーミングのいずれかの形式でコンテンツをストリームできます。ただし、.ismt (スムーズ ストリーミング テキスト トラック) 内のキャプションのある Fragment MP4 を取り込む場合は、ストリーミングを配信できるのはスムーズ ストリーミング クライアントのみになります。
SCTE-35|広告の挿入のキューには、デジタル信号システムが使用されます。ダウンストリームの受信側は信号を使用して、割り当てられた時間のストリームに広告をスプライスします。SCTE 35 は、入力ストリームのスパース トラックとして送信する必要があります。<p><p>現時点では、信号の伝送がサポートされている入力ストリーム形式は Fragmented MP4 (スムーズ ストリーミング) のみです。サポートされている出力形式も、スムーズ ストリーミングのみです。


##<a id="Considerations"></a>考慮事項

オンプレミスのライブ エンコーダーを使用してマルチビットレートのストリームをチャネルに送信する際は、次の考慮事項を適用します。

- 取り込みポイントにデータを送信するための十分な空きのインターネット接続があるかどうかを確認します。
- 受信するマルチビットレート ストリームには、最大 10 のビデオ品質レベル (10 層) と、最大 5 つのオーディオ トラックを含めることができます。
- ビデオ品質レベル (層) の最高の平均ビットレートは、10 Mbps 以下である必要があります。
- すべてのビデオとオーディオ ストリームの平均ビットレートの合計は、25 Mbps である必要があります。
- チャネルやチャネルに関連付けられたプログラムの実行中は、入力プロトコルを変更できません。別のプロトコルが必要な場合は、入力プロトコルごとに別のチャネルを作成します。


チャネルと関連コンポーネントの作業に関するその他の考慮事項は次のとおりです。

- ライブ エンコーダーを再構成する際は、毎回チャネルで **Reset** メソッドを呼び出します。チャネルをリセットする前に、プログラムを停止する必要があります。チャネルをリセットしたら、プログラムを再起動します。
- チャネルを停止できるのは実行中の状態で、チャネルのすべてのプログラムが停止しているときのみです。
- 既定では、Media Services アカウントに追加できるチャネル数は 5 つのみです。詳しくは、「[クォータと制限](media-services-quotas-and-limitations.md)」をご覧ください。
- チャネルやチャネルに関連付けられたプログラムの実行中は、入力プロトコルを変更できません。別のプロトコルが必要な場合は、入力プロトコルごとに別のチャネルを作成します。
- チャネルが**実行中**状態のときにのみ課金されます。詳しくは、[こちら](media-services-live-streaming-with-onprem-encoders.md#states)のセクションを参照してください。

##オンプレミスのエンコーダーからマルチ ビットレートのライブ ストリームを受信するチャネルを作成する方法

オンプレミスのライブ エンコーダーの詳細については、「[Azure Media Services でのサード パーティ ライブ エンコーダーの使用](https://azure.microsoft.com/blog/azure-media-services-rtmp-support-and-live-encoders/)」をご覧ください。

チャネルとプログラムの作成および管理方法を表示する**ポータル**、**.NET**、**REST API** を選択します。

[AZURE.INCLUDE [media-services-selector-manage-channels](../../includes/media-services-selector-manage-channels.md)]



##Media Services のラーニング パス

[AZURE.INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

##フィードバックの提供

[AZURE.INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]



##関連トピック

[Azure Media Services の Fragmented MP4 ライブ インジェスト仕様](media-services-fmp4-live-ingest-overview.md)

[Azure Media Services を使用してライブ ストリーミング イベントを配信する](media-services-overview.md)

[Media Services の概念](media-services-concepts.md)

[live-overview]: ./media/media-services-manage-channels-overview/media-services-live-streaming-current.png

<!---HONumber=AcomDC_0921_2016-->