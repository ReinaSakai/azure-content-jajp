<properties
   pageTitle="Microsoft クラウド サービスとネットワーク セキュリティ | Microsoft Azure"
   description="セキュリティで保護されたネットワーク環境を作成するために Azure で利用できる主な機能の一部を説明します。"
   services="virtual-network"
   documentationCenter="na"
   authors="tracsman"
   manager="rossort"
   editor=""/>

<tags
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="03/14/2016"
   ms.author="jonor;sivae"/>

# Microsoft クラウド サービスとネットワーク セキュリティ

Microsoft クラウド サービスでは、ハイパースケール サービスとインフラストラクチャ、エンタープライズ レベルの機能、ハイブリッド接続の多くの選択肢を提供しています。顧客は、これらのサービスにインターネット経由でアクセスするか、プライベート ネットワーク接続を提供する Azure ExpressRoute を使用してアクセスするかを選択できます。Microsoft Azure Platform により、顧客はインフラストラクチャをクラウドにシームレスに拡張し、多層アーキテクチャを構築できます。また、サード パーティは、セキュリティ サービスや仮想アプライアンスを提供することで、機能を強化できます。このホワイト ペーパーでは、顧客が ExpressRoute 経由でアクセスした Microsoft クラウド サービスを使用するときに考慮する必要がある、セキュリティとアーキテクチャの問題の概要を説明します。また、Azure 仮想ネットワークでより安全なサービスを作成する方法についても説明します。

## はじめに
次の論理チャートは、Azure Platform で利用可能な多数のセキュリティ手法の具体例を示しています。クイック リファレンスでは、現在の状況に最も適した例を紹介します。詳細については、このホワイト ペーパーを引き続きお読みください。![セキュリティ オプションのフローチャート][0]

[例 1: 境界ネットワーク (DMZ、非武装地帯、およびスクリーン サブネットとも呼ばれます) を構築し、ネットワーク セキュリティ グループ (NSG) を含むアプリケーションを保護します。](#example-1-build-a-simple-dmz-with-nsgs)</br> [例 2: DMZ を構築し、ファイアウォールと NSG を含むアプリケーションを保護します。](#example-2-build-a-dmz-to-protect-applications-with-a-firewall-and-nsgs)</br> [例 3: 境界ネットワークを構築し、ファイアウォール、ユーザー定義ルート (UDR)、および NSG を含むネットワークを保護します。](#example-3-build-a-dmz-to-protect-networks-with-a-firewall-udr-and-nsg)</br> [例 4: サイト間の仮想アプライアンス仮想プライベート ネットワーク (VPN) を使用してハイブリッド接続を追加する](#example-4-adding-a-hybrid-connection-with-a-site-to-site-virtual-appliance-vpn)</br> [例 5: サイト間の Azure ゲートウェイ VPN を使用してハイブリッド接続を追加する](#example-5-adding-a-hybrid-connection-with-a-site-to-site-azure-gateway-vpn)</br> [例 6: ExpressRoute を使用してハイブリッド接続を追加する](#example-6-adding-a-hybrid-connection-with-expressroute)</br> 仮想ネットワーク間の接続、高可用性、サービス チェイニングの追加の例については、今後数か月の間にこのドキュメントに追加される予定です。

## Microsoft のコンプライアンスとインフラストラクチャの保護
Microsoft は、企業顧客が必要とするコンプライアンス イニシアチブのサポートにおいて指導的立場を獲得しました。Azure のコンプライアンス認定の一部を次に示します。![Azure のコンプライアンス バッジ][1]

詳細については、[Microsoft Trust Center (Microsoft セキュリティ センター)](https://azure.microsoft.com/support/trust-center/compliance/) のコンプライアンス情報をご覧ください。

Microsoft は、非常にスケール性の高いグローバル サービスの実行に必要なクラウド インフラストラクチャを保護するための包括的なアプローチを備えています。Microsoft のクラウド インフラストラクチャには、物理的なデータ センターに加え、ハードウェア、ソフトウェア、ネットワーク、管理スタッフ、運用スタッフも含まれています。

![Azure セキュリティ機能][2]

このアプローチでは、顧客が Microsoft のクラウドでサービスをデプロイするためのより安全な基盤を提供します。次の手順では、顧客がこれらのサービスを保護するためのセキュリティ アーキテクチャを設計して作成します。

## 従来のセキュリティ アーキテクチャと境界ネットワーク
Microsoft は、クラウド インフラストラクチャの保護に多額の投資を行っていますが、顧客も自身のクラウド サービスとリソース グループを保護する必要があります。セキュリティの多層アプローチにより、最大限の保護が実現されます。境界ネットワークのセキュリティ ゾーンは、信頼されていないネットワークから内部のネットワーク リソースを保護します。境界ネットワークは、インターネットと企業の保護された IT インフラストラクチャの間にあるネットワークの境界または領域を指します。

一般的な企業ネットワークでは、複数層のセキュリティ デバイスにより、コア インフラストラクチャの境界が厳重に防備されています。各層の境界は、デバイスとポリシー適用ポイントで構成されます。デバイスには、ファイアウォール、分散型サービス拒否 (DDoS) 防止、侵入検出システムまたは侵入防止システム (IDS/IPS)、VPN デバイスなどがあります。ポリシーの適用は、ファイアウォール ポリシー、アクセス制御リスト (ACL)、または特定のルーティングという形で行われます。ネットワークにおける防御の最前線では、インターネットから着信トラフィックを直接受け取ると、これらのメカニズムを組み合わせて攻撃や有害なトラフィックをブロックすると同時に、有効な要求をネットワークの内部に送信します。このトラフィックは、境界ネットワーク内のリソースに直接ルーティングされます。その後、そのリソースはネットワーク内のさらに深い場所にあるリソースと "対話" し、まずは検証のために次の境界を通過します。最も外側の層が境界ネットワークと呼ばれます。ネットワークのこの部分は、インターネットに接する部分で、通常、内側と外側は何らかの形で保護されています。次の図は、2 つのセキュリティ境界を持つ企業ネットワークにおける単一のサブネット境界ネットワークの例を示しています。

![企業ネットワーク内の境界ネットワーク][3]

境界ネットワークの実装に使用されるアーキテクチャは、Web ファームの前面に位置する単純なロード バランサーから、トラフィックをブロックして企業ネットワークのより深い層を保護するために各境界でさまざまなメカニズムを使用する複数サブネット境界ネットワークまで多岐にわたります。境界ネットワークを構築する方法は、組織の具体的なニーズや全体的なリスク許容度によって異なります。

顧客がワークロードをパブリック クラウドに移行する場合、重要なのは、Azure の境界ネットワーク アーキテクチャで同様の機能をサポートし、コンプライアンスとセキュリティの要件を満たすことです。このドキュメントでは、顧客がセキュリティで保護されたネットワーク環境を Azure で構築する方法に関するガイドラインを示します。境界ネットワークに重点を置いて説明しますが、ネットワーク セキュリティのさまざまな側面についても包括的に説明します。次の質問は、この説明のポイントとなります。

- Azure では、境界ネットワークをどのように構築できますか。
- 境界ネットワークの構築に使用できる Azure の機能を教えてください。
- バック エンドのワークロードはどのように保護できますか。
- インターネット通信はどのように Azure のワークロードに制御されていますか。
- Azure のデプロイからオンプレミスのネットワークを保護するにはどうすればよいですか。
- サード パーティ製のアプライアンスやサービスと比較して、どのような場合にネイティブの Azure セキュリティ機能を使用する必要がありますか。

次の図は、Azure が顧客に提供するさまざまなセキュリティ層を示しています。これらの層は、Azure プラットフォーム自体とユーザー定義機能の両方でネイティブです。

![Azure のセキュリティ アーキテクチャ][4]

インターネットから受信する場合は、Azure DDoS が Azure に対する大規模な攻撃から保護します。次の層は、顧客が定義したパブリック エンドポイントです。これらのエンドポイントは、クラウド サービスを通過して仮想ネットワークに到達できるトラフィックを決定するために使用されます。ネイティブの Azure Virtual Network の分離により、その他すべてのネットワークから完全に分離されると、そのトラフィックだけが、ユーザーが構成した経路と方法を介して流れます。これらの経路と方法が次の層となります。次の層では、NSG、UDR、ネットワーク仮想アプライアンスを使用して DMZ などのセキュリティ境界を構築し、保護されているネットワークにおけるアプリケーションのデプロイを保護することができます。

次のセクションでは、Azure 仮想ネットワークの概要を説明します。これらの仮想ネットワークは顧客によって作成され、デプロイされたワークロードの接続先となります。仮想ネットワークは、Azure で顧客のデプロイメントを保護する境界ネットワークの構築に必要なすべてのネットワーク セキュリティ機能の基盤となります。

## Azure 仮想ネットワークの概要
インターネット トラフィックが Azure 仮想ネットワークに到達する前に、Azure Platform に固有のセキュリティ層が 2 つあります。

1.	**DDoS 保護**: DDoS 保護は、大規模なインターネットベースの攻撃から Azure Platform 自体を保護する Azure 物理ネットワークの層です。このような攻撃では 1 回の攻撃で複数の"bot"ノードを使用し、インターネット サービスに過剰な負荷をかけます。Azure には、すべての着信インターネット接続に対する堅牢な DDoS 防御網が用意されています。この DDoS 保護層にはユーザーが構成できる属性がないため、顧客はこの層にアクセスできません。これにより、Azure はプラットフォームとして大規模な攻撃から保護されますが、個々の顧客アプリケーションは直接保護されるわけではありません。局地的な攻撃に対しては、顧客が復元層を追加で構成できます。たとえば、顧客 A がパブリック エンドポイントで大規模な DDoS 攻撃を受けた場合、Azure はそのサービスへの接続をブロックします。顧客 A は、その攻撃に関係のない別の仮想ネットワークまたはサービス エンドポイントにフェールオーバーして、サービスを復元できます。注目すべきは、そのエンドポイントで顧客 A が影響を受ける可能性はあっても、そのエンドポイント以外の他のサービスには影響がないことです。さらに、他の顧客やサービスからは、その攻撃による影響がわかりません。
2.	**サービス エンドポイント**: エンドポイントを使用することで、クラウド サービスまたはリソース グループは公開インターネット IP アドレスとポートを公開できます。エンドポイントでは、ネットワーク アドレス変換 (NAT) を使用して、トラフィックを Azure 仮想ネットワークの内部アドレスとポートにルーティングします。これは、外部トラフィックが仮想ネットワークに到達するための主な経路です。サービス エンドポイントは、仮想ネットワークに渡されるトラフィックと、そのトラフィックが仮想ネットワークのどこでどのように変換されるかを決定するためにユーザーが構成できます。

トラフィックが仮想ネットワークに到達すると、多くの機能を使用できるようになります。Azure 仮想ネットワークは、顧客がワークロードを接続するための基盤であり、基本的なネットワーク レベルのセキュリティが適用されます。次の機能と特性を使用する顧客の場合、これが Azure のプライベート ネットワーク (仮想ネットワークのオーバーレイ) になります。
 
- **トラフィックの分離**: 仮想ネットワークは、Azure Platform でのトラフィックの分離境界となります。ある仮想ネットワーク内の仮想マシン (VM) と別の仮想ネットワーク内の VM は、両方の仮想ネットワークを同じ顧客が作成した場合でも、直接通信することはできません。これは、仮想ネットワーク内では顧客の VM と通信がプライベートであることを保証する重要な特性です。
- **多層トポロジ**: 仮想ネットワークでは、サブネットを割り当て、ワークロードのさまざまな要素 ("層") に個別のアドレス空間を指定することで、多層トポロジを定義できます。このような論理的なグループとトポロジを使用すると、顧客は、ワークロードの種類に基づいて異なるアクセス ポリシーを定義するだけでなく、各層の間のトラフィック フローを制御することもできます。
- **クロスプレミス接続**: Azure で 1 つの仮想ネットワークと複数のオンプレミス サイトや他の仮想ネットワークとの間にクロスプレミス接続を確立できます。これを行うには、Azure VPN Gateway またはサード パーティ製のネットワーク仮想アプライアンスを使用します。Azure では、標準的な IPsec/IKE プロトコルと ExpressRoute プライベート接続を使用したサイト間 (S2S) VPN をサポートしています。
- **NSG** を使用して、必要なレベルの粒度 (ネットワーク インターフェイス、個々の VM、仮想サブネットなど) でルール (ACL) を作成できます。顧客は、仮想ネットワーク内でのワークロード間の通信を許可または拒否することで、クロスプレミス接続を介した顧客のネットワーク上のシステムからのアクセス、または直接インターネット通信を制御できます。
- **UDR** と **IP 転送**を使用して、仮想ネットワーク内の異なる層間の通信経路を定義できます。ファイアウォール、IDS/IPS、その他の仮想アプライアンスをデプロイし、これらのセキュリティ アプライアンスを介してネットワーク トラフィックをルーティングすることで、セキュリティ境界ポリシーを適用、監査、検査することができます。
- Azure Marketplace の**ネットワーク仮想アプライアンス**: ファイアウォール、ロード バランサー、IDS/IPS などのセキュリティ アプライアンスは、Azure Marketplace と VM イメージ ギャラリーで入手できます。これらのアプライアンスを仮想ネットワーク、特にセキュリティ境界 (境界ネットワーク サブネットを含む) にデプロイすることで、多層のセキュリティで保護されたネットワーク環境を実現できます。

このような機能を使用した場合に Azure で境界ネットワーク アーキテクチャがどのように構築されるかについて一例を次に示します。

![Azure 仮想ネットワーク内の境界ネットワーク][5]

## 境界ネットワークの特性と要件
境界ネットワークは、ネットワークのフロントエンドとして、インターネットからの通信と直接接続するように設計されています。受信パケットは、バックエンド サーバーに到達するまでにセキュリティ アプライアンス (ファイアウォール、IDS、IPS など) を通過する必要があります。また、ワークロードからインターネットへのパケットも、ネットワークから送信される前に、ポリシーの適用、検査、監査を行うために境界ネットワーク内のセキュリティ アプライアンスを通過する場合があります。さらに、境界ネットワークでは、顧客の仮想ネットワークとオンプレミス ネットワーク間のクロスプレミスの VPN ゲートウェイをホストすることもできます。

### 境界ネットワークの特性
上の図を参照し、次の適切な境界ネットワークの特性を確認します。

- インターネットに面する場合:
    - 境界ネットワーク サブネット自体がインターネットに接続されており、インターネットと直接通信します。
    - パブリック IP、VIP、サービス エンドポイントは、フロントエンドのネットワークとデバイスにインターネット トラフィックを渡します。
    - インターネットからの受信トラフィックは、セキュリティ デバイスを通過してからフロントエンド ネットワーク上の他のリソースに到達します。
    - 送信セキュリティが有効になっている場合、トラフィックは、セキュリティ デバイスを通過してから、最終段階としてインターネットに渡されます。
- 保護されたネットワーク:
    - インターネットからコア インフラストラクチャへの直接パスはありません。
    - コア インフラストラクチャへのチャネルは、NSG、ファイアウォール、VPN デバイスなどのセキュリティ デバイスを経由する必要があります。
    - 他のデバイスがインターネットとコア インフラストラクチャの橋渡しをすることはできません。
    - インターネットに面した境界と、保護されているネットワークに面した境界の両方にあるセキュリティ デバイス (例: 上の図で表示されている 2 つのファイアウォール アイコン) は、実際には、各境界に区別されたルールまたはインターフェイスを持つ 1 つの仮想アプライアンスである可能性があります (つまり、境界ネットワークの両方の境界の負荷を処理する、論理的に分離された 1 つのデバイス)。
- その他の一般的な慣行と制約:
    - ワークロードには、ビジネスに不可欠な情報を格納することはできません。
    - 境界ネットワークの構成とデプロイへのアクセスと更新は、承認された管理者のみに制限されます。

### 境界ネットワーク に関する要件
これらの特性を有効にするために、正常な境界ネットワークを実装するための仮想ネットワークの要件に関する次のガイドラインに従います。

- **サブネット アーキテクチャ:** サブネット全体が境界ネットワークとして特化されるように仮想ネットワークを指定すると、同じ仮想ネットワーク内の他のサブネットから分離されます。これにより、境界ネットワークとその他の内部またはプライベートのサブネット層との間のトラフィックは、ユーザー定義ルートを使用してサブネットの境界上にあるファイアウォールまたは IDS/IPS 仮想アプライアンスを通過します。
- **NSG:** インターネットとの通信を許可するために境界ネットワーク サブネット自体を開いた状態にしておく必要があります。ただし、顧客が NSG をバイパスする必要があるという意味ではありません。一般的なセキュリティの慣例に従い、インターネットに公開されるネットワークの場所を最小限に抑えます。デプロイや開いている特定のアプリケーション プロトコルまたはポートへのアクセスを許可するリモート アドレスの範囲をロック ダウンします。ただし、それが不可能な場合もあります。たとえば、顧客が Azure に外部 Web サイトを所有している場合、境界ネットワークでは、パブリック IP アドレスからの着信 Web 要求を許可する必要がありますが、開く必要がある Web アプリケーション ポートは TCP:80 と TCP:443 のみです。
- **ルーティング テーブル:** 境界ネットワーク サブネット自体は、インターネットと直接通信できる必要がありますが、ファイアウォールやセキュリティ アプライアンスを介さずにバックエンド ネットワークまたはオンプレミス ネットワークと直接通信することはできないようにする必要があります。
- **セキュリティ アプライアンスの構成:** 境界ネットワークと他の保護されているネットワークとの間でパケットをルーティングして検査するために、セキュリティ アプライアンス (ファイアウォール、IDS、IPS デバイスなど) はマルチホームにすることができます。この場合、境界ネットワークとバックエンド サブネットに個別の NIC を使用することがあります。境界ネットワークの NIC は、対応する NSG と境界ネットワーク ルーティング テーブルを使用して、インターネットと直接通信します。バックエンド サブネットに接続する NIC では、対応するバックエンド サブネットの NSG とルーティング テーブルがより限定的になります。
- **セキュリティ アプライアンスの機能:** 境界ネットワークにデプロイされているセキュリティ アプライアンスは、通常、次の機能を実行します。
    - ファイアウォール: 受信要求にファイアウォール ルールまたはアクセス制御ポリシーを適用します。
    - 脅威の検出と防止: インターネットからの悪意のある攻撃を検出して軽減します。
    - 監査とログ記録: 監査と分析のために詳細なログを保持します。
    - リバース プロキシ: 受信要求を対応するバックエンド サーバーにリダイレクトします。これには、フロントエンド デバイス (通常はファイアウォール) の宛先アドレスをバックエンド サーバーのアドレスにマッピングして変換することが含まれます。
    - 転送プロキシ: NAT 機能を提供し、仮想ネットワーク内からインターネットに対して開始された通信の監査を実行します。
    - ルーター: 仮想ネットワーク内で着信トラフィックとサブネット間トラフィックを転送します。
    - VPN デバイス: 顧客のオンプレミス ネットワークと Azure の仮想ネットワークとの間のクロスプレミス VPN 接続でクロスプレミスの VPN ゲートウェイとして動作します。
    - VPN サーバー: Azure の仮想ネットワークに接続している VPN クライアントを受け入れます。

>[AZURE.TIP] 2 つのグループ (境界ネットワークのセキュリティ ギアへのアクセスが許可されている個人と、アプリケーションの開発、デプロイ、操作の管理者として承認された個人) を区別してください。これらのグループを区別すると、義務の分離も可能になり、1 人でアプリケーション セキュリティとネットワーク セキュリティの両方の制御をバイパスできなくなります。

### ネットワーク境界を構築する際の質問事項
このセクションでは、特に記載している場合を除き、"ネットワーク" という用語は、サブスクリプション管理者によって作成された、プライベートな Azure 仮想ネットワークを指しています。この用語は、Azure 内の基となる物理ネットワークを指していません。

また、Azure 仮想ネットワークは、従来のオンプレミス ネットワークを拡張するためによく使用されます。サイト間または ExpressRoute のハイブリッド ネットワーク ソリューションと境界ネットワーク アーキテクチャを組み合わせることができます。これは、ネットワーク セキュリティ境界の作成する際の重要な考慮事項です。

境界ネットワークと複数のセキュリティ境界を使用したネットワークを構築する場合は、次の 3 つの重要な質問を確認する必要があります。

#### 1) 境界はいくつ必要か
最初の決定ポイントでは、特定のシナリオで必要なセキュリティ境界の数を決定します。

- 境界が 1 つの場合: 仮想ネットワークとインターネットの間のフロントエンド境界ネットワーク上に 1 つ。
- 境界が 2 つの場合: 境界ネットワークのインターネット側に 1 つ、境界ネットワーク サブネットと Azure 仮想ネットワーク内のバックエンド サブネットの間に 1 つ。
- 境界が 3 つの場合: 境界ネットワークのインターネット側に 1 つ、境界ネットワーク サブネットとバックエンド サブネットの間に 1 つ、バックエンド サブネットとオンプレミス ネットワークの間に 1 つ。
- 境界が N 個の場合: 変数の数。セキュリティの要件によっては、特定のネットワークに適用できるセキュリティ境界の数に制限はありません。

必要な境界の数と種類は、企業のリスク許容度と、実装する特定のシナリオに応じて異なります。これは、多くの場合、リスクおよびコンプライアンス チーム、ネットワーク/プラットフォーム チーム、アプリケーション開発チームなど、組織内の複数のグループによって共同で決定されます。各実装に適切なセキュリティへの対応を確保するために、セキュリティ、関連するデータ、使用されるテクノロジに詳しい人物がこの決定について権限を持つ必要があります。

>[AZURE.TIP] 特定の状況のセキュリティ要件を満たす境界の数は最小限に抑えてください。境界の数が増えると、運用とトラブルシューティングが困難になり、複数の境界ポリシーの管理に伴うオーバーヘッドも時間と共に増大します。ただし、境界の数が不足するとリスクが高まります。適切なバランスを見つけることが重要です。

![3 つのセキュリティ境界を含むハイブリッド ネットワーク][6]

上の図では、3 つのセキュリティ境界ネットワークの概要を示しています。境界は、境界ネットワークとインターネット、Azure フロント エンドとバック エンド プライベート サブネット、および Azure バックエンド サブネットとオンプレスの企業ネットワークの間に存在します。

#### 2\. 境界をどこに配置するか
境界の数が決まったら、どこでそれらを実装するかが次の決定ポイントになります。一般的には、次の 3 つの選択肢があります。
- インターネット ベースの中間サービスの使用時 (例: クラウドベースの Web アプリケーション ファイアウォール。このドキュメントでは説明しません)
- Azure のネイティブ機能またはネットワーク仮想アプライアンスの使用時
- オンプレミス ネットワーク上の物理デバイスの使用時

純粋に Azure ネットワークの場合、Azure のネイティブ機能 (例: Azure Load Balancer) または Azure の優れたパートナー エコシステムのネットワーク仮想アプライアンス (例: Check Point ファイアウォール) を選択できます。

Azure とオンプレミス ネットワークの間に境界が必要な場合は、セキュリティ デバイスを接続の片側 (または両側) に配置できます。したがって、セキュリティ ギアを配置する場所について決定する必要があります。

上の図では、インターネットと境界ネットワーク間の境界およびフロントエンドとバックエンド間の境界が完全に Azure 内部に含まれており、Azure のネイティブ機能とネットワーク仮想アプライアンスのいずれかになっています。Azure (バックエンド サブネット) と企業ネットワーク間の境界上のセキュリティ デバイスは、Azure 側にある場合、オンプレミス側にある場合、さらに、両方のデバイスを組み合わせたものである場合もあります。どちらのオプションにも、真剣に検討する必要のある重要な長所と短所があります。

たとえば、オンプレミス ネットワーク側で既存の物理的なセキュリティ ギアを使用する場合、新しいギアが必要ないという長所があります。再構成だけが必要です。ただし、セキュリティ ギアで確認できるように、すべてのトラフィックを Azure からオンプレミス ネットワークに戻す必要があるという短所もあります。このため、Azure 間のトラフィックがセキュリティ ポリシー適用のためにオンプレミス ネットワークに強制的に戻される場合、大幅な遅延が発生し、アプリケーションのパフォーマンスとユーザー エクスペリエンスに影響することがあります。

#### 3\. どのように境界を実装するか
各セキュリティ境界では、機能の要件が異なる可能性があります (例: 境界ネットワークのインターネット側では IDS とファイアウォール ルールが必要ですが、境界ネットワークとバックエンド サブネットの間には ACL のみが必要)。使用するデバイスは、シナリオとセキュリティ要件に応じて決定します。次のセクションの例 1、2、3 では、使用可能ないくつかのオプションについて説明します。Azure のネイティブ ネットワーク機能と Azure で使用できるパートナー エコシステムのデバイスを調べると、ほとんどすべてのシナリオを解決できる多種多様なオプションが見つかります。

実装に関するもう 1 つの重要な決定ポイントとして、Azure とオンプレミス ネットワークの接続方法があります。Azure 仮想ゲートウェイまたはネットワーク仮想アプライアンスを使用する必要があります。 これらのオプションについては、次のセクション (例 4、5、6) でさらに詳しく説明します。

さらに、Azure 内の仮想ネットワーク間のトラフィックが必要な場合もあります。これらのシナリオは、今後追加される予定です。

前の質問に対する答えがわかれば、「[はじめに](#fast-start)」セクションが、特定のシナリオに最も適切な例を見つけるのに役立ちます。

## 例: Azure 仮想ネットワークでセキュリティ境界を構築する
### 例 1: 境界ネットワークを構築し、NSG を含むアプリケーションを保護する
[「はじめに」に戻る](#fast-start) | [この例の詳細な構築手順][Example1]

![NSG を含む受信境界ネットワーク][7]

#### 環境の説明
この例で使用するサブスクリプションには、以下のものが含まれています。

- 2 つのクラウド サービス: "FrontEnd001" と "BackEnd001"
- 2 つのサブネット ("FrontEnd" と "BackEnd") を含む仮想ネットワーク "CorpNetwork"
- 両方のサブネットに適用されるネットワーク セキュリティ グループ
- アプリケーション Web サーバーを表す Windows サーバー ("IIS01")
- アプリケーション バックエンド サーバーを表す 2 つの Windows サーバー ("AppVM01"、"AppVM02")
- DNS サーバーを表す Windows サーバー ("DNS01")

スクリプトと Azure Resource Manager テンプレートについては、[詳細な構築手順][Example1]をご覧ください。

#### NSG の説明
この例では、NSG グループを作成し、そこに 6 つのルールを設定します。

>[AZURE.TIP] 一般的には、具体的な "Allow" ルールを作成してから、包括的な "Deny" ルールを作成してください。どのルールが先に評価されるかは、割り当てる優先度によって決まります。具体的なルールが一度適用されたトラフィックに対しては、他のルールは評価されません。NSG ルールは、(サブネットから見て) 受信方向または送信方向のどちらか一方に適用できます。

ここでは、受信トラフィックに対して次の内容のルールを作成しています。

1.	内部的な DNS トラフィック (ポート 53) を許可する。
2.	インターネットから任意の仮想マシンへの RDP トラフィック (ポート 3389) を許可する。
3.	インターネットから Web サーバー (IIS01) への HTTP トラフィック (ポート 80) を許可する。
4.	IIS01 から AppVM1 への任意のトラフィック (すべてのポート) を許可する。
5.	インターネットから仮想ネットワーク全体 (両方のサブネット) への任意のトラフィック (すべてのポート) を拒否する。
6.	フロントエンド サブネットからバックエンド サブネットへの任意のトラフィック (すべてのポート) を拒否する。

これらのルールが各サブネットにバインドされている状態で、インターネットから Web サーバーへの HTTP 要求が受信された場合、ルール 3 (Allow) とルール 5 (Deny) の両方が該当します。しかし、ルール 3 の方が優先度が高いので、ルール 3 のみが適用され、ルール 5 は作用しません。したがって、Web サーバーへの HTTP 要求は許可されます。同じトラフィックが DNS01 サーバーに到達しようとしている場合は、ルール 5 (Deny) が最初に適用されるので、トラフィックはサーバーに到達できません。フロントエンド サブネットからバックエンド サブネットへの通信は、ルール 6 (Deny) によってブロックされます (ルール 1 とルール 4 で許可されたトラフィックを除く)。これによって、フロントエンドにある Web アプリケーションのセキュリティが攻撃者によって侵害されたとしてもバックエンド ネットワークは保護されます。バックエンドの "保護された" ネットワークに対する攻撃者のアクセスは (AppVM01 サーバー上で公開されているリソースのみに) 限定されます。

インターネットへ向かうトラフィックは、既定の送信ルールによって許可されています。この例では、送信トラフィックを許可していますが、送信ルールに対する変更は一切行っていません。両方向のトラフィックをロック ダウンするには、ユーザー定義ルーティングが必要です (例 3 を参照)。

#### まとめ
これは、バックエンド サブネットを受信トラフィックから分離する方法としては比較的単純な例です。詳細については、[詳細な構築手順][Example1]をご覧ください。この手順の内容は次のとおりです。

- PowerShell スクリプトを使用してこの境界ネットワークを構築する方法
- Azure Resource Manager テンプレートを使用してこの境界ネットワークを構築する方法
- 各 NSG コマンドの詳細な説明
- トラフィック フローの詳細なシナリオ (各層でトラフィックを許可または拒否する方法を示します)


 ### 例 2: ファイアウォールと NSG から成る境界ネットワークを構築してアプリケーションを保護する [「はじめに」に戻る](#fast-start) | [この例の詳細な構築手順][Example2]

![NVA、NSG を含む受信境界ネットワーク][8]

#### 環境の説明
この例で使用するサブスクリプションには、以下のものが含まれています。

- 2 つのクラウド サービス: "FrontEnd001" と "BackEnd001"
- 2 つのサブネット ("FrontEnd" と "BackEnd") を含む仮想ネットワーク "CorpNetwork"
- 両方のサブネットに適用されるネットワーク セキュリティ グループ
- フロントエンド サブネットに接続されたネットワーク仮想アプライアンス (この場合はファイアウォール)
- アプリケーション Web サーバーを表す Windows サーバー ("IIS01")
- アプリケーション バックエンド サーバーを表す 2 つの Windows サーバー ("AppVM01"、"AppVM02")
- DNS サーバーを表す Windows サーバー ("DNS01")

スクリプトと Azure Resource Manager テンプレートについては、[詳細な構築手順][Example2]をご覧ください。

#### NSG の説明
この例では、NSG グループを作成し、そこに 6 つのルールを設定します。

>[AZURE.TIP] 一般的には、具体的な "Allow" ルールを作成してから、包括的な "Deny" ルールを作成してください。どのルールが先に評価されるかは、割り当てる優先度によって決まります。具体的なルールが一度適用されたトラフィックに対しては、他のルールは評価されません。NSG ルールは、(サブネットから見て) 受信方向または送信方向のどちらか一方に適用できます。

ここでは、受信トラフィックに対して次の内容のルールを作成しています。

1.	内部的な DNS トラフィック (ポート 53) を許可する。
2.	インターネットから任意の仮想マシンへの RDP トラフィック (ポート 3389) を許可する。
3.	ネットワーク仮想アプライアンス (ファイアウォール) へのすべてのインターネット トラフィック (すべてのポート) を許可する。
4.	IIS01 から AppVM1 への任意のトラフィック (すべてのポート) を許可する。
5.	インターネットから仮想ネットワーク全体 (両方のサブネット) への任意のトラフィック (すべてのポート) を拒否する。
6.	フロントエンド サブネットからバックエンド サブネットへの任意のトラフィック (すべてのポート) を拒否する。

これらのルールが各サブネットにバインドされている状態で、インターネットからファイアウォールへの HTTP 要求が受信された場合、ルール 3 (Allow) とルール 5 (Deny) の両方が該当します。しかし、ルール 3 の方が優先度が高いので、ルール 3 のみが適用され、ルール 5 は作用しません。したがって、ファイアウォールへの HTTP 要求は許可されます。同じトラフィックが IIS01 サーバーに到達しようとしている場合は、そのサーバーがフロントエンド サブネット上にあったとしても、ルール 5 (Deny) が適用されるので、トラフィックはサーバーに到達できません。フロントエンド サブネットからバックエンド サブネットへの通信は、ルール 6 (Deny) によってブロックされます (ルール 1 とルール 4 で許可されたトラフィックを除く)。これによって、フロントエンドにある Web アプリケーションのセキュリティが攻撃者によって侵害されたとしてもバックエンド ネットワークは保護されます。バックエンドの "保護された" ネットワークに対する攻撃者のアクセスは (AppVM01 サーバー上で公開されているリソースのみに) 限定されます。

インターネットへ向かうトラフィックは、既定の送信ルールによって許可されています。この例では、送信トラフィックを許可していますが、送信ルールに対する変更は一切行っていません。両方向のトラフィックをロック ダウンするには、ユーザー定義ルーティングが必要です (例 3 を参照)。

#### ファイアウォール ルールの説明
ファイアウォールには、転送ルールを作成する必要があります。この例でルーティングするのは、インターネットからファイアウォールを介して Web サーバーに到達する受信トラフィックだけであるため、必要なネットワーク アドレス転送 (NAT) ルールは 1 つだけです。

この転送ルールでは、HTTP のポート 80 または HTTPS のポート 443 を宛先としてファイアウォールに到達したすべての受信元アドレスを受け入れます。転送ルールは、ファイアウォールのローカル インターフェイスから送出され、IP アドレス 10.0.1.5 の Web サーバーにリダイレクトされます。

#### まとめ
アプリケーションをファイアウォールで保護したり、バックエンド サブネットを受信トラフィックから切り離したりする方法として、これは比較的わかりやすい部類に入ります。詳細については、[詳細な構築手順][Example2]をご覧ください。この手順の内容は次のとおりです。

- PowerShell スクリプトを使用してこの境界ネットワークを構築する方法
- Azure Resource Manager テンプレートを使用してこの例を構築する方法
- 各 NSG コマンドとファイアウォール ルールの詳細な説明
- トラフィック フローの詳細なシナリオ (各層でトラフィックを許可または拒否する方法を示します)

### 例 3: 境界ネットワークを構築し、ファイアウォール、UDR、および NSG を含むネットワークを保護する
[「はじめに」に戻る](#fast-start) | [この例の詳細な構築手順][Example3]

![NVA、NSG、UDR を含む双方向境界ネットワーク][9]

#### 環境の説明
この例で使用するサブスクリプションには、以下のものが含まれています。

- 3 つのクラウド サービス: “SecSvc001”、“FrontEnd001”、“BackEnd001”
- 3 つのサブネット ("SecNet"、"FrontEnd"、"BackEnd") を含む仮想ネットワーク "CorpNetwork"
- SecNet サブネットに接続されたネットワーク仮想アプライアンス (この場合はファイアウォール)
- アプリケーション Web サーバーを表す Windows サーバー ("IIS01")
- アプリケーション バックエンド サーバーを表す 2 つの Windows サーバー ("AppVM01"、"AppVM02")
- DNS サーバーを表す Windows サーバー ("DNS01")

スクリプトと Azure Resource Manager テンプレートについては、[詳細な構築手順][Example3]をご覧ください。

#### UDR の説明
既定では、次のシステム ルートが定義されています。

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.0.0/16}     VNETLocal                            Active   Default    
         {0.0.0.0/0}       Internet                             Active   Default    
         {10.0.0.0/8}      Null                                 Active   Default    
         {100.64.0.0/10}   Null                                 Active   Default    
         {172.16.0.0/12}   Null                                 Active   Default    
         {192.168.0.0/16}  Null                                 Active   Default

VNETLocal は、特定のネットワークの仮想ネットワークに対して必ず定義されるアドレス プレフィックスです (つまり、具体的な仮想ネットワークがそれぞれどのように定義されているかによって変わります)。その他のシステム ルートは静的ルートで、表に示すように既定値となっています。

この例では、フロントエンドとバックエンドのサブネットに対して 1 つずつ、2 つのルーティング テーブルが作成されます。各サブネットに適した静的ルートをそれぞれのテーブルに読み込みます。この例では、すべてのトラフィック (0.0.0.0/0) をファイアウォール (次ホップ = 仮想アプライアンスの IP アドレス) 経由で送信する 3 つのルートが各テーブルに存在します。

1. ローカル サブネット トラフィック。次ホップは定義されず、ローカル サブネット トラフィックはファイアウォールをバイパスすることができます。
2. 仮想ネットワーク トラフィック。次ホップはファイアウォールとして定義され、ローカル仮想ネットワーク トラフィックの直接ルーティングを許可する既定のルールは上書きされます。
3. その他すべてのトラフィック (0/0)。次ホップはファイアウォールとして定義されます。

>[AZURE.TIP] UDR にローカル サブネットのエントリがないと、ローカル サブネットの通信が切断されます。
> - この例で、VNETLocal を指す 10.0.1.0/24 は重要です。この指定がないと、Web サーバー (10.0.1.4) から別のローカル サーバー (たとえば、10.0.1.25) に送信されるパケットは失敗します。それは、NVA に送信されたパケットは NVA によってサブネットに送信され、そのパケットはサブネットから NVA に再び送信されるためです。
> - 通信先のそれぞれのサブネットに直接接続されている複数の NIC を備えるアプライアンスでは、ルーティング ループに陥る可能性が高くなります。多くの場合、このようなアプライアンスには、従来のオンプレミス アプライアンスが該当します。

ルーティング テーブルは作成されると、対応するサブネットにバインドされます。フロントエンド サブネット ルーティング テーブルは、作成されて、サブネットにバインドされると、次のようになります。

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.1.0/24}     VNETLocal                            Active 
		 {10.0.0.0/16}     VirtualAppliance 10.0.0.4            Active    
         {0.0.0.0/0}       VirtualAppliance 10.0.0.4            Active

>[AZURE.NOTE] ExpressRoute circuit が接続されているゲートウェイ サブネットに UDR を適用できるようになりました。
>
> ExpressRoute またはサイト間ネットワークを使用した境界ネットワークを有効にする方法の例については、例 3 と 4 で説明します。


#### IP 転送の説明
IP 転送は、UDR と併用される機能です。実際には自分自身宛てではないトラフィックを受信し、最終的な宛先に転送することができる仮想アプライアンス上の設定です。

たとえば、AppVM01 からのトラフィックが DNS01 サーバーに要求を行う場合、UDR ではこの要求をファイアウォールにルーティングします。IP 転送が有効になっている場合、DNS01 (10.0.2.4) 宛てのトラフィックはまずアプライアンス (10.0.0.4) で受信されて、最終的な宛先 (10.0.2.4) に転送されます。ファイアウォールで IP 転送が無効になっている場合、ルート テーブルに次ホップとしてファイアウォールが指定されていても、アプライアンスは、そのトラフィックを受け付けません。仮想アプライアンスを使用するには、忘れずに UDR と併せて IP 転送を有効にすることが重要です。

#### NSG の説明
この例では、NSG グループを作成し、そこに単一のルールを設定します。このグループは、(SecNet を除いた) フロントエンドとバックエンドのサブネットにのみバインドします。ここで作成しているルールの内容は次のとおりです。

- インターネットから仮想ネットワーク全体 (すべてのサブネット) への任意のトラフィック (すべてのポート) を拒否する。

この例では NSG が使用されていますが、その主な役割は、手動構成のミスに対する第 2 の防御層としての機能です。その目的は、フロントエンド サブネットまたはバックエンド サブネットへのインターネットからの受信トラフィックをすべてブロックすることです。必ず SecNet サブネットを介してファイアウォールに (その後必要に応じてフロントエンド サブネットまたはバックエンド サブネットに) トラフィックを流す必要があります。加えて UDR ルールが設定されているので、万一フロントエンド サブネットまたはバックエンド サブネットにうまく到達できたトラフィックも (UDR が設定されているために) すべてファイアウォールへと送信させることができます。ファイアウォールは、そのようなトラフィックを非対称フローと見なし、その送信トラフィックは破棄されます。つまり、サブネットを保護するセキュリティは次の 3 つの層で構成されます。
- FrontEnd001 と BackEnd001 のクラウド サービスのエンドポイントをすべて閉じる。
- インターネットからのトラフィックを NSG で拒否する。
- 非対称トラフィックをファイアウォールで破棄する

この例の NSG に存在するルールは 1 つだけである点に注目してください。セキュリティ サブネットを含め、仮想ネットワーク全体でインターネット トラフィックを拒否する、というルールが 1 つあるだけです。しかし、この NSG がバインドされるのはフロントエンド サブネットとバックエンド サブネットだけです。セキュリティ サブネットに入ってくるトラフィックに対してはルールの処理は適用されません。その結果、トラフィックはセキュリティ サブネットに到達します。

#### ファイアウォール規則
ファイアウォールには、転送ルールを作成する必要があります。受信トラフィック、送信トラフィック、仮想ネットワーク間トラフィックをすべてブロックまたは転送する役割を果たすファイアウォールには、多くのファイアウォール ルールが必要です。また、すべての受信トラフィックは、セキュリティ サービスのパブリック IP アドレス (の各種ポート) に到達し、そこでファイアウォールの処理が適用されます。手戻り作業をなくすために、あらかじめ論理フローを図式化したうえでサブネットとファイアウォール ルールを設定することをお勧めします。次の図では、この例で使用するファイアウォール ルールを論理的に示しています。
 
![ファイアウォール ルールの論理ビュー][10]

>[AZURE.NOTE] 使用するネットワーク仮想アプライアンスによって管理ポートは異なります。ここでは、ポート 22、801、807 が使用されている Barracuda NextGen Firewall を例に説明しています。ご使用のデバイスの管理に使用される実際のポートについては、アプライアンス製造元のマニュアルを参照してください。

#### ファイアウォール ルールの説明
上の論理図では、セキュリティのサブネットを省略しています。これは、セキュリティ サブネットは、ファイアウォールが唯一のリソースであるためです。この図にはファイアウォール ルールが示されており、実際の経路を指定するのではなく論理的にトラフィック フローを許可または拒否していることがわかります。また、RDP トラフィック用に選択した外部ポートは、他のトラフィックよりも大きな番号範囲 (8014 ～ 8026) を使用しています。また、見やすくするために、外部ポート番号は、ローカル IP アドレスの最後の 2 オクテットとある程度揃える形で選択しました (たとえば、ローカル サーバー アドレス 10.0.1.4 は外部ポート 8014 に関連付けられています)。ただし、競合さえしなければ、もっと大きなポート番号を使用してもかまいません。

この例では、次の 7 種類のルールが必要です。

- 外部ルール (受信トラフィック用):
  1.	ファイアウォール管理ルール: ネットワーク仮想アプライアンスの管理ポート宛てのトラフィックを通過させるための App Redirect ルールです。
  2.	RDP ルール (Windows Server ごと): 個々のサーバーを RDP 経由で管理するためには、この 4 つのルール (サーバー 1 台につき 1 つ) が必要となります。使用するネットワーク仮想アプライアンスの機能によっては、これを 1 つのルールにまとめることもできます。
  3.	アプリケーション トラフィック ルール: フロント エンド Web トラフィック用とバックエンド トラフィック用 (Web サーバーからデータ層など) の 2 つのアプリケーション トラフィック ルールがあります。これらのルールの構成は、(サーバーが置かれている) ネットワーク アーキテクチャとトラフィック フロー (トラフィック フローの方向と使用ポート) によって異なります。
      - 実際のアプリケーション トラフィックは、1 つ目のルールによってアプリケーション サーバーに到達できます。他のルールがセキュリティや管理を目的としているのに対し、アプリケーション トラフィック ルールの目的は、外部のユーザーまたはサービスがアプリケーションにアクセスできるようにすることです。この例では、1 台の Web サーバー (ポート 80) があります。このため、単一のファイアウォール アプリケーション ルールで、外部 IP 宛ての受信トラフィックを Web サーバーの内部 IP アドレスにリダイレクトします。リダイレクトされたトラフィック セッションは、NAT を介して内部サーバーに変換されます。
      - 2 つ目のルールはバック エンド ルールです。任意のポートを介した Web サーバーから AppVM01 サーバー (ただし、AppVM02 は不可) への通信を許可します。
- 内部ルール (仮想ネットワーク間のトラフィック用)
  4.	インターネットへの送信ルール: 任意のネットワークから特定のネットワークへのトラフィックの通過を許可するルールです。通常、ファイアウォールにはこのルールが、既定のルールとして (ただし無効状態で) あらかじめ設定されています。この例では、このルールを有効にする必要があります。
  5.	DNS ルール: DNS (ポート 53) のトラフィックのみに DNS サーバーへの通過を許可するルールです。この環境では、フロント エンドからバックエンドへのトラフィックの大部分がブロックされます。このルールによって、任意のローカル サブネットからの DNS を明示的に許可します。
  6.	サブネット間ルール: バックエンド サブネット上の任意のサーバーからフロントエンド サブネット上の任意のサーバーへの接続を許可するルールです (ただしその逆は不可)。
- フェールセーフ ルール (上記のルールに該当しないトラフィック用):
  7.	全トラフィック拒否ルール: このルールは (優先度の観点から) 必ず最後に置く必要があります。先行するいずれのルールにも該当しなかったトラフィック フローが、このルールによって破棄されます。これは既定のルールであり、通常は有効になっています。通常、変更は不要です。

>[AZURE.TIP] この例では、わかりやすくするために 2 つ目のアプリケーション トラフィック ルールで任意のポートを許可しています。実際のシナリオでは、ポートとアドレス範囲をできるだけ具体的に指定して、このルールに対する攻撃対象領域を小さくする必要があります。

以上のルールをすべて作成したら、各ルールの優先度を再確認し、トラフィックの許可または拒否が意図したとおりになっていることを確かめてください。この例では、各ルールに優先順位が割り当てられています。

#### まとめ
これは、ネットワークを保護および分離するのに、前の例よりやや複雑ですが完成度の高い方法です (例 2 ではアプリケーションの保護のみ、例 1 ではサブネットの分離のみを行います)。この設計では、両方向のトラフィックを監視できます。また、受信アプリケーション サーバーを保護するだけでなく、このネットワーク上のすべてのサーバーにネットワーク セキュリティ ポリシーを適用します。さらに、使用されるアプライアンスに応じて、トラフィックの完全な監査と対応を実現できます。詳細については、[詳細な構築手順][Example3]をご覧ください。この手順の内容は次のとおりです。

- PowerShell スクリプトを使用してこの例の境界ネットワークを構築する方法
- Azure Resource Manager テンプレートを使用してこの例を構築する方法
- 各 UDR、NSG コマンド、ファイアウォール ルールの詳細な説明
- トラフィック フローの詳細なシナリオ (各層でトラフィックを許可または拒否する方法を示します)

### 例 4: サイト間の仮想アプライアンス仮想プライベート ネットワーク (VPN) を使用してハイブリッド接続を追加する
[「はじめに」に戻る](#fast-start) | 詳細な構築手順 (近日公開予定)

![NVA 接続のハイブリッド ネットワークを含む境界ネットワーク][11]

#### 環境の説明
ネットワーク仮想アプライアンス (NVA) を使用するハイブリッド ネットワークは、例 1、2、3 で説明したどの境界ネットワークの種類にも追加できます。

上の図に示すように、オンプレミス ネットワークを NVA を介して Azure 仮想ネットワークに接続する場合は、インターネット経由 (サイト間) の VPN 接続を使用します。

>[AZURE.NOTE] Azure のパブリック ピアリング オプションを有効にした状態で ExpressRoute を使用する場合は、静的ルートを作成する必要があります。これにより、ExpressRoute WAN エッジを介さずに企業のインターネットの外に送出されるように NVA VPN の IP アドレスにルーティングされます。ExpressRoute の Azure パブリック ピアリング オプションで必要な NAT により、VPN セッションが中断される可能性があります。

VPN が確立されると、NVA はすべてのネットワークとサブネットの中心的な "ハブ" になります。ファイアウォールの転送ルールにより、許可するトラフィック フロー、NAT を介して変換するトラフィック フロー、リダイレクトするトラフィック フロー、削除するトラフィック フロー (オンプレミス ネットワークと Azure の間のトラフィック フローの場合でも) が決まります。

トラフィック フローは、具体的な使用事例に応じてこの設計パターンで最適化されることもあれば、状態が低下することもあるため、慎重に検討する必要があります。

例 3 で構築した環境を使用した後にサイト間 VPN のハイブリッド ネットワーク接続を追加すると、次のような設計になります。

![サイト間 VPN を使用した NVA 接続を含む境界ネットワーク][12]

オンプレミスのルーター、または VPN 用の NVA と互換性のあるその他のネットワーク デバイスが VPN クライアントになります。この物理デバイスの役割は、NVA で VPN 接続を開始して維持することです。

論理的な観点から、NVA にとってのネットワークは、4 つの独立した "セキュリティ ゾーン" で、NVA のルールがこれらのゾーン間のトラフィックに対する司令塔のように見えます。

![NVA 観点からの論理ネットワーク][13]

#### まとめ
サイト間 VPN のハイブリッド ネットワーク接続を Azure 仮想ネットワークに追加すると、安全な方法でオンプレミス ネットワークを Azure に拡張できます。VPN 接続を使用している場合は、トラフィックが暗号化され、インターネット経由でルーティングされます。この例の NVA は、セキュリティ ポリシーの適用と管理を一元化しています。詳細については、詳細な構築手順をご覧ください (近日公開予定)。この手順の内容は次のとおりです。

- PowerShell スクリプトを使用してこの例の境界ネットワークを構築する方法
- Azure Resource Manager テンプレートを使用してこの例を構築する方法
- トラフィック フローの詳細なシナリオ (この設計によるトラフィック フローを示します)

### 例 5: サイト間の Azure ゲートウェイ VPN を使用してハイブリッド接続を追加する
[「はじめに」に戻る](#fast-start) | 詳細な構築手順 (近日公開予定)

![ゲートウェイ接続のハイブリッド ネットワークを含む境界ネットワーク][14]

#### 環境の説明
Azure VPN ゲートウェイを使用するハイブリッド ネットワークは、例 1 または 2 で説明した境界ネットワークの種類に追加できます。

上の図に示すように、オンプレミス ネットワークを Azure VPN ゲートウェイを介して Azure 仮想ネットワークに接続する場合は、インターネット経由 (サイト間) の VPN 接続を使用します。

>[AZURE.NOTE] Azure のパブリック ピアリング オプションを有効にした状態で ExpressRoute を使用する場合は、静的ルートを作成する必要があります。これにより、ExpressRoute WAN エッジを介さずに企業のインターネットの外に送出されるように NVA VPN の IP アドレスにルーティングされます。ExpressRoute の Azure パブリック ピアリング オプションで必要な NAT により、VPN セッションが中断される可能性があります。

次の図は、このオプションの 2 つのネットワーク エッジを示しています。1 つ目のエッジでは、Azure 内のネットワークのトラフィック フローおよび Azure とインターネット間のトラフィック フローを NVA と NSG が制御します。2 つ目のエッジは Azure VPN ゲートウェイで、オンプレミスと Azure の間で完全に切り離されて分離したネットワーク エッジです。

トラフィック フローは、具体的な使用事例に応じてこの設計パターンで最適化されることもあれば、状態が低下することもあるため、慎重に検討する必要があります。

例 1 で構築した環境を使用した後にサイト間 VPN のハイブリッド ネットワーク接続を追加すると、次のような設計になります。

![ExpressRoute 接続を使用したゲートウェイ接続を含む境界ネットワーク][15]

#### まとめ
サイト間 VPN のハイブリッド ネットワーク接続を Azure 仮想ネットワークに追加すると、安全な方法でオンプレミス ネットワークを Azure に拡張できます。ネイティブの Azure VPN ゲートウェイを使用する場合、トラフィックは IPSec によって暗号化され、インターネット経由でルーティングされます。また、Azure VPN ゲートウェイを使用すると、よりコストが低いオプションを利用できます (サード パーティ製の NVA と同様に、追加のライセンス コストはありません)。NVA が使用されていない例 1 では、これが最も経済的です。詳細については、詳細な構築手順をご覧ください (近日公開予定)。この手順の内容は次のとおりです。

- PowerShell スクリプトを使用してこの例の境界ネットワークを構築する方法
- Azure Resource Manager テンプレートを使用してこの例を構築する方法
- トラフィック フローの詳細なシナリオ (この設計によるトラフィック フローを示します)

### 例 6: ExpressRoute を使用してハイブリッド接続を追加する
[「はじめに」に戻る](#fast-start) | 詳細な構築手順 (近日公開予定)

![ゲートウェイ接続のハイブリッド ネットワークを含む境界ネットワーク][16]

#### 環境の説明
ExpressRoute のプライベート ピアリング接続を使用するハイブリッド ネットワークは、例 1 または 2 で説明したいずれかの境界ネットワークの種類に追加できます。

上の図に示すように、ExpressRoute のプライベート ピアリングでは、オンプレミス ネットワークと Azure 仮想ネットワークが直接接続されています。トラフィックは、サービス プロバイダーのネットワークと Microsoft Azure のネットワークを通過するだけで、インターネットに到達することはありません。

>[AZURE.NOTE] Azure 仮想ゲートウェイで使用される動的ルーティングの複雑さから、UDR と ExpressRoute の使用には若干の制限があります。制限事項は次のとおりです。
>
>- ExpressRoute によってリンクされている Azure 仮想ゲートウェイの接続先となるゲートウェイ サブネットに UDR を適用できません。
>- ExpressRoute によってリンクされている Azure 仮想ゲートウェイを、UDR が関連付けられている他のサブネットの NextHop デバイスとすることはできません。
>
>
<br />

>[AZURE.TIP] ExpressRoute を使用すると、企業のネットワーク トラフィックはインターネットから切り離された状態で維持されるため、セキュリティは強化され、パフォーマンスが大幅に向上します。ExpressRoute プロバイダーのサービス レベル アグリーメントも考慮されます。ExpressRoute を使用する場合、Azure ゲートウェイでは最大 2 GB/秒のスループットを実現できるのに対し、サイト間 VPN を使用する場合は、Azure ゲートウェイの最大スループットは 200 MB/秒になります。

次の図のように、このオプションを使用すると、環境には 2 つのネットワーク エッジが用意されます。NVA と NSG は Azure 内のネットワークのトラフィック フローおよび Azure とインターネット間のトラフィック フローを制御しますが、ゲートウェイは、オンプレミスと Azure の間で完全に切り離されて分離したネットワーク エッジです。

トラフィック フローは、具体的な使用事例に応じてこの設計パターンで最適化されることもあれば、状態が低下することもあるため、慎重に検討する必要があります。

例 1 で構築した環境を使用した後に ExpressRoute ハイブリッド ネットワーク接続を追加すると、次のような設計になります。

![ExpressRoute 接続を使用したゲートウェイ接続を含む境界ネットワーク][17]

#### まとめ
ExpressRoute プライベート ピアリング ネットワーク接続を追加すると、安全で待機時間が短く、パフォーマンスの高い方法でオンプレミス ネットワークを Azure に拡張できます。また、ネイティブの Azure ゲートウェイを使用すると、この例のように、よりコストが低いオプションを利用できます (サード パーティ製の NVA と同様に、追加のライセンスはありません)。詳細については、詳細な構築手順をご覧ください (近日公開予定)。この手順の内容は次のとおりです。

- PowerShell スクリプトを使用してこの例の境界ネットワークを構築する方法
- Azure Resource Manager テンプレートを使用してこの例を構築する方法
- トラフィック フローの詳細なシナリオ (この設計によるトラフィック フローを示します)

## 参照
### 役に立つ Web サイトとドキュメント
- Azure Resource Manager を使用した Azure へのアクセス
- PowerShell を使用した Azure へのアクセス: [https://azure.microsoft.com/documentation/articles/powershell-install-configure/](./powershell-install-configure.md)
- 仮想ネットワークのドキュメント: [https://azure.microsoft.com/documentation/services/virtual-network/](https://azure.microsoft.com/documentation/services/virtual-network/)
- ネットワーク セキュリティ グループのドキュメント: [https://azure.microsoft.com/documentation/articles/virtual-networks-nsg/](./virtual-network/virtual-networks-nsg.md)
- ユーザー定義ルーティングのドキュメント: [https://azure.microsoft.com/documentation/articles/virtual-networks-udr-overview/](./virtual-network/virtual-networks-udr-overview.md)
- Azure の仮想ゲートウェイ: [https://azure.microsoft.com/documentation/services/vpn-gateway/](https://azure.microsoft.com/documentation/services/vpn-gateway/)
- サイト間 VPN: [https://azure.microsoft.com/documentation/articles/vpn-gateway-create-site-to-site-rm-powershell](./vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md)
- ExpressRoute のドキュメント (「はじめに」および「方法」をご確認ください): [https://azure.microsoft.com/documentation/services/expressroute/](https://azure.microsoft.com/documentation/services/expressroute/)

<!--Image References-->
[0]: ./media/best-practices-network-security/flowchart.png "Security Options Flowchart"
[1]: ./media/best-practices-network-security/compliancebadges.png "Azure Compliance Badges"
[2]: ./media/best-practices-network-security/azuresecurityfeatures.png "Azure Security Features"
[3]: ./media/best-practices-network-security/dmzcorporate.png "A DMZ in a Corporate network"
[4]: ./media/best-practices-network-security/azuresecurityarchitecture.png "Azure Security Architecture"
[5]: ./media/best-practices-network-security/dmzazure.png "A DMZ in an Azure Virtual Network"
[6]: ./media/best-practices-network-security/dmzhybrid.png "Hybrid Network with Three Security Boundaries"
[7]: ./media/best-practices-network-security/example1design.png "Inbound DMZ with NSG"
[8]: ./media/best-practices-network-security/example2design.png "Inbound DMZ with NVA and NSG"
[9]: ./media/best-practices-network-security/example3design.png "Bi-directional DMZ with NVA, NSG, and UDR"
[10]: ./media/best-practices-network-security/example3firewalllogical.png "Logical View of the Firewall Rules"
[11]: ./media/best-practices-network-security/example4designoptions.png "DMZ with NVA Connected Hybrid Network"
[12]: ./media/best-practices-network-security/example4designs2s.png "DMZ with NVA Connected Using a Site-to-Site VPN"
[13]: ./media/best-practices-network-security/example4networklogical.png "Logical Network from NVA Perspective"
[14]: ./media/best-practices-network-security/example5designoptions.png "DMZ with Azure Gateway Connected Site-to-Site Hybrid Network"
[15]: ./media/best-practices-network-security/example5designs2s.png "DMZ with Azure Gateway Using Site-to-Site VPN"
[16]: ./media/best-practices-network-security/example6designoptions.png "DMZ with Azure Gateway Connected ExpressRoute Hybrid Network"
[17]: ./media/best-practices-network-security/example6designexpressroute.png "DMZ with Azure Gateway Using an ExpressRoute Connection"

<!--Link References-->
[Example1]: ./virtual-network/virtual-networks-dmz-nsg-asm.md
[Example2]: ./virtual-network/virtual-networks-dmz-nsg-fw-asm.md
[Example3]: ./virtual-network/virtual-networks-dmz-nsg-fw-udr-asm.md
[Example4]: ./virtual-network/virtual-networks-hybrid-s2s-nva-asm.md
[Example5]: ./virtual-network/virtual-networks-hybrid-s2s-agw-asm.md
[Example6]: ./virtual-network/virtual-networks-hybrid-expressroute-asm.md
[Example7]: ./virtual-network/virtual-networks-vnet2vnet-direct-asm.md
[Example8]: ./virtual-network/virtual-networks-vnet2vnet-transit-asm.md

<!---HONumber=AcomDC_0921_2016-->