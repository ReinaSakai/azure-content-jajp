<properties
	pageTitle="障害復旧に対応したネットワーク インフラストラクチャの設計 | Microsoft Azure"
	description="この記事では、Azure Site Recovery を使用するためのネットワーク設計の考慮事項について説明します。"
	services="site-recovery"
	documentationCenter=""
	authors="prateek9us"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery"
	ms.date="09/19/2016"
	ms.author="pratshar"/>

#  障害復旧に対応したネットワーク インフラストラクチャの設計

この記事は IT プロフェッショナルを読者として想定しています。ビジネス継続性と障害復旧 (BCDR: Business Continuity and Disaster Recovery) インフラストラクチャの構築、実装、サポートを担当する方や、BCDR サービスのサポートと強化に Microsoft Azure Site Recovery (ASR) を活用したいと考えている方が対象となります。ここでは、System Center Virtual Machine Manager サーバーのデプロイ、拡張サブネットとサブネット フェールオーバーの長所と欠点、Microsoft Azure 内の仮想サイトに障害復旧を構築する方法について実際的な見地から考察します。

## Overview

[Azure Site Recovery (ASR)](https://azure.microsoft.com/services/site-recovery/) は、ビジネス継続性と障害復旧 (BCDR) を目的に、仮想化されたアプリケーションの保護と復旧をつかさどる Microsoft Azure サービスです。このドキュメントでは、Site Recovery を使って仮想マシン (VM) をレプリケートするネットワークの設計プロセスを、障害復旧サイトに対する IP 範囲とサブネットの設計を中心にわかりやすく説明します。

また、テスト時や障害発生時に BCDR サービスをサポートするマルチサイトの仮想データセンターを Site Recovery で実際に設計、導入する方法についても取り上げます。

365 日 24 時間つながることが当たり前の時代となり、インフラストラクチャとアプリケーションの常時稼働は、かつてないほど重要な意味を帯びています。ビジネス継続性と障害復旧 (BCDR) の目的は、組織が通常業務をすばやく再開できるように、障害の発生したコンポーネントを復元することです。めったに起こることのない壊滅的な事象に対応する障害復旧戦略を立てることは、大きな困難を伴います。将来を予測することだけでも難しいのに、起こる確率のきわめて低い事象が対象となればなおさらです。しかも大規模な災害を想定して十分な保護対策を講じるためには、多大なコストが発生します。

BCDR 計画には、目標復旧時間 (RTO) と回復ポイントの目標 (RPO) を障害復旧計画の一環として設定することが欠かせません。顧客のデータ センターで障害が発生した場合、顧客は Azure Site Recovery を使い、セカンダリ データ センターまたは Microsoft Azure に保管されているレプリケート済みの仮想マシンをすばやく (短い RTO で)、最小限のデータ損失 (短い RPO) でオンライン状態に移行できます。

フェールオーバーは ASR によって実行されます。ASR は、指定された仮想マシンをプライマリ データ センターからセカンダリ データ センターまたは Azure (シナリオによって異なる) にあらかじめコピーしたうえで、そのレプリカを定期的に更新します。インフラストラクチャの計画時は、社内の RTO 目標や RPO 目標の達成をさまたげる可能性のあるボトルネックとしてネットワーク設計を捉えるようにしてください。

障害復旧ソリューションの導入を計画する管理者がまず抱く疑問のひとつは、フェールオーバーの完了後、どのようにして仮想マシンへのアクセスを確保するかです。フェールオーバーの後に仮想マシンの接続先となるネットワークは、管理者が ASR を使用して選択できます。プライマリ サイトが VMM サーバーで管理されている場合は、ネットワーク マッピングを使用して選択できます。詳細については、「[ネットワーク マッピングを準備する](site-recovery-network-mapping.md)」を参照してください。

復旧サイト用のネットワークを設計する場合、管理者には次の 2 つの選択肢があります。

- 復旧サイトのネットワーク用に異なる IP アドレス範囲を使用する。このシナリオでは、フェールオーバー後の仮想マシンに、新しい IP アドレスが割り当てられます。この場合 DNS の更新は管理者が行う必要があります。DNS の更新方法については、[こちら](site-recovery-vmm-to-vmm.md#test-your-deployment)をご覧ください。
- 復旧サイトのネットワーク用に同じ IP アドレス範囲を使用する。プライマリ サイトと同じ IP アドレスをフェールオーバー後も維持した方が、管理者にとって都合のよい場合もあります。通常は管理者がルートを更新して、新しい場所の IP アドレスを指定する必要があります。しかし、プライマリ サイトと復旧サイトとの間にデプロイされているのが拡張 VLAN であるケースでは、仮想マシンの IP アドレスを維持するという選択肢に説得力が増してきます。同じ IP アドレスを維持することで、フェールオーバー後に行うネットワーク関連の手順が不要となるため、復旧プロセスが単純化されます。


障害復旧ソリューションの導入を計画する管理者がまず抱く疑問のひとつは、フェールオーバーの完了後、どのようにしてアプリケーションへのアクセスを確保するかです。最近のアプリケーションはほとんどの場合、多かれ少なかれネットワークに依存しています。当然、サイト間で物理的にサービスを移動することにはネットワークの問題が伴います。障害復旧ソリューションでこの問題に対処するためには、大きく 2 つの方法があります。1 つは、固定 IP アドレスを維持する方法です。移動するサービスおよびホスティング サーバーが物理的に異なる場所で開始されても、アプリケーションはそれらに関する IP アドレス構成を新しい場所で有効にします。回復サイトへの移行中に IP アドレスを完全に変更する方法もあります。それが 2 つ目の方法です。どちらの方法もいくつかの導入形態があります。以降、その点について簡単に説明します。

復旧サイト用のネットワークを設計する場合、管理者には次の 2 つの選択肢があります。

## 方法 1: IP アドレスを維持する 

障害復旧作業の観点からいえば、固定 IP アドレスを使うのが最も導入しやすいように見えますが、実際には、さまざまな問題が潜んでいるために、この方法が選ばれることはまれです。Azure Site Recovery を使用すれば、すべてのシナリオで IP アドレスを保持することができます。IP アドレスを維持する場合は、フェールオーバー機能に課せられる制約をあらかじめ十分に把握したうえで判断する必要があります。IP アドレスを維持するかどうかの判断に役立つと思われる要素について見てみましょう。これは、2 つの方法 (拡張サブネットを使用する方法とサブネット全体のフェールオーバーを実行する方法) で実行できます。

### 拡張サブネット

この場合、プライマリ側と DR 側とで同時にサブネットが利用できる状態となります。簡単に言えば、サーバーとその IP (レイヤー 3) 構成をセカンダリ サイトに移動することができ、トラフィックはネットワークによって新しい場所に自動的にルーティングされます。これはサーバーから見れば処理は簡単ですが、多くの課題があります。

- レイヤー 2 (データ リンク層) の観点からは、拡張 VLAN を管理できるネットワーク機器が必要になります。ただしこの種の機器は現在広く普及しており、大きな問題ではなくなりつつあります。それよりも大きな問題は、VLAN を拡張すると、障害ドメインの影響範囲が両方のサイトに広がることです (実質的に単一障害点になります)。そのようなことはごくまれですが、ブロードキャスト ストームが発生したのに問題を切り分けることができなかったというのは、実際に起こっている話です。最後に挙げた問題については、さまざまな見方があります。多くの成功事例がある反面、"このテクノロジはもう二度と導入しない" という意見も聞かれます。
- Microsoft Azure を DR サイトとして使用している場合、拡張サブネットは使用できません。


### Subnet failover

サブネット フェールオーバーを導入すれば、複数のサイトに対してサブネットを拡張しなくても、前述した拡張サブネット ソリューションの恩恵を享受できます。この場合サブネットは、必ずサイト 1 とサイト 2 のどちらかにのみ存在し、両方のサイトに同時に存在することはありません。フェールオーバーの発生時に IP アドレス空間を維持する手段としては、サイトからサイトへサブネットを移動するよう、ルーター インフラストラクチャをプログラムで制御する方法が考えられます。フェールオーバーの際にサブネットは、関連する保護対象 VM と一緒に移動します。この方法の大きな欠点は、フェールオーバー時にサブネット全体を移動する必要があるということです。一見問題ないように思えるかもしれませんが、そのことがフェールオーバーの粒度に影響する可能性があります。

Contoso という架空の企業を例に、サブネット全体をフェールオーバーしながら、どのようにして VM を復旧場所にレプリケートできるのかを見てみましょう。まず、2 つのオンプレミス拠点間で VM をレプリケートするときのサブネットの管理方法に注目し、その後、[障害復旧サイトとして Azure を使用](#failover-to-azure)した場合にサブネットのフェールオーバーがどのように動作するかについて説明します。

#### セカンダリ オンプレミス サイトへのフェールオーバー

ここでは、すべての VM の IP アドレスを維持し、サブネット全体をまとめてフェールオーバーする状況を見ていきます。プライマリ サイトでは、アプリケーションがサブネット 192.168.1.0/24 で実行されます。フェールオーバーが発生すると、そのサブネットに属しているすべての仮想マシンが復旧サイトにフェールオーバーされて、それぞれの IP アドレスが維持されます。サブネット 192.168.1.0/24 に属しているすべての仮想マシンが復旧サイトに移動されたことになるので、それに応じてルートを変更する必要があります。

以下の図では、プライマリ サイトと復旧サイトとの間、第 3 のサイトとプライマリ サイトとの間、そして第 3 のサイトと復旧サイトとの間のルートに適宜変更を加える必要があります。

次の図は、フェールオーバーする前のサブネットを示しています。サブネット 192.168.0.1/24 が、フェールオーバー前はプライマリ サイトでアクティブで、フェールオーバー後は復旧サイトでアクティブになります。

![Before Failover](./media/site-recovery-network-design/network-design2.png)

フェールオーバー前


次の図は、フェールオーバー後のネットワークとサブネットを示しています。
	
![After Failover](./media/site-recovery-network-design/network-design3.png)

フェールオーバー後

セカンダリ サイトがオンプレミスであり、管理に VMM サーバーを使用している場合、ASR は、特定の仮想マシンの保護を有効にする際に、次のワークフローに従ってネットワーク リソースを割り当てます。

- 仮想マシン上のネットワーク インターフェイスごとに IP アドレスを割り当てます。IP アドレスは、各 System Center VMM インスタンスの関連するネットワークに対して定義された静的 IP アドレス プールから取得されます。
- 復旧サイトのネットワークに対して、プライマリ サイトのネットワークの IP アドレス プールと同じ IP アドレス プールが管理者によって定義されている場合、レプリカ仮想マシンに IP アドレスを割り当てるときに、プライマリ仮想マシンと同じ IP アドレスを割り当てます。この IP は VMM 内で予約はされますが、フェールオーバー IP としては設定されません。フェールオーバー IP は、フェールオーバーの直前に設定されます。

![Retain IP address](./media/site-recovery-network-design/network-design4.png)
	
Figure 5

図 5 は、レプリカ仮想マシン用のフェールオーバー TCP/IP 設定を Hyper-V コンソールで表示したところです。フェールオーバー後、仮想マシンが起動する直前にこれらの設定が反映されます。

同じ IP が利用できない場合、ASR は、定義されている IP アドレス プールから他に利用できる IP アドレスを取得して割り当てます。

VM の保護が有効な状態で、次のサンプル スクリプトを使用すると、仮想マシンに割り当てられている IP を確認できます。それと同じ IP がフェールオーバー IP として設定され、フェールオーバー時に VM に割り当てられます。

    	$vm = Get-SCVirtualMachine -Name <VM_NAME>
		$na = $vm[0].VirtualNetworkAdapters>
		$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
		$ip.address  

>[AZURE.NOTE] 仮想マシンで DHCP を使用している場合、IP アドレスの管理に ASR は一切関与しません。復旧サイトに IP アドレスを供給する DHCP サーバーが、プライマリ サイトの場合と同じ範囲のアドレスを供給できることを管理者が確認する必要があります。

#### Azure へのフェールオーバー

Azure Site Recovery (ASR) では、仮想マシンの障害復旧サイトとして Microsoft Azure を使用できます。この場合、対処すべき制約が 1 つ増えます。

Woodgrove Bank という架空の会社の例で見てみましょう。Woodgrove Bank では、基幹業務アプリケーションをオンプレミス インフラストラクチャでホストし、モバイル アプリケーションを Azure でホストしています。Woodgrove Bank が Azure 内でホストしている VM とオンプレミス サーバーとの接続は、サイト間 (S2S) 仮想プライベート ネットワーク (VPN) によって提供されます。そのため Azure における Woodgrove Bank の仮想ネットワークは、Woodgrove Bank のオンプレミス ネットワークの延長と考えることができます。この通信は、Woodgrove Bank のエッジと Azure Virtual Network とを結ぶ S2S VPN によって実現されています。Woodgrove は今後、そのデータセンターで実行されているワークロードを、ASR で Azure にレプリケートすることを検討しています。Woodgrove は低コストの障害復旧対策を希望しており、この方法なら、その要件を満たし、パブリック クラウド環境にデータを保存することができます。Woodgrove が取り組むべき課題は、ハードコーディングされた IP アドレスに依存するアプリケーションと構成です。そこで、Azure へのフェールオーバー後もアプリケーションの IP アドレスを維持することが必須となります。

Woodgrove は、Azure で実行されるリソースの IP アドレスを 172.16.1.0/24 と 172.16.2.0/24 の範囲から割り当てることにしました。

IP アドレスを維持した状態で仮想マシンを Azure にレプリケートするためには、Azure 仮想ネットワークを作成する必要があります。アプリケーションがオンプレミス サイトから Azure へとシームレスにフェールオーバーできるよう、このネットワークはオンプレミス ネットワークの延長であることが必要です。Azure に作成された仮想ネットワークには、ポイント対サイト VPN 接続だけでなく、サイト間 VPN 接続を追加することができます。サイト間接続をセットアップするとき、Azure ネットワークでトラフィックをオンプレミスの場所 (Azure ではローカル ネットワークと呼ばれる) にルーティングできるのは、IP アドレス範囲がオンプレミスの IP アドレス範囲と異なる場合だけです。このような制限があるのは、Azure でサブネットの拡張がサポートされていないためです。すなわち、オンプレミス上にサブネット 192.168.1.0/24 がある場合、Azure ネットワークにローカル ネットワーク 192.168.1.0/24 を追加することはできません。これは予想される状況です。その理由は、Azure が、サブネットにアクティブな VM がないこと、およびサブネットが災害復旧の目的でのみ作成されることを認識しないことにあります。Azure ネットワークからネットワーク トラフィックを正しくルーティングできるようにするには、ネットワーク内のサブネットとローカル ネットワークが競合してはなりません。

![Before Subnet Failover](./media/site-recovery-network-design/network-design7.png)

フェールオーバー前

Woodgrove がビジネス要件を満たすためには、次のワークフローを実行する必要があります。

- フェールオーバーされた仮想マシンの作成先となるネットワーク (ここでは "Recovery Network" とします) を別途作成します。
- フェールオーバー後も VM の IP を確実に維持するために、VM のプロパティの [構成] タブに移動して、オンプレミス側の VM と同じ IP を指定し、[保存] をクリックします。VM がフェールオーバーされると、Azure Site Recovery によって、指定した IP が仮想マシンに割り当てられます。

![Network properties](./media/site-recovery-network-design/network-design8.png)

フェールオーバーが作動し、指定した IP の仮想マシンが Recovery Network 内に作成されると、このネットワークへの接続が [VNet 間接続](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md)を使って確立されます。必要であれば、この操作をスクリプト化することもできます。サブネットのフェールオーバーについて前のセクションで説明したように、Azure へのフェールオーバーの場合も、192.168.1.0/24 が Azure に移動されたことを反映するためにルートを適切に変更する必要があります。

![After Subnet Failover](./media/site-recovery-network-design/network-design9.png)

フェールオーバー後

上の図で示されている "Azure Network" が実際の環境にはない場合は、フェールオーバー後、"Primary Site" と "Recovery Network" の間にサイト間 VPN 接続を作成できます。


## 方法 2: IP アドレスを変更する

これまでの経験からすると、こちらの方法の方が多く採用されているように思います。この場合、フェールオーバーに関係するすべての VM の IP アドレスを変更することになります。この方法の短所は、アプリケーションのアドレスが IPx から IPy に切り替わったことを、フェールオーバー後のネットワークに "学習" させる必要がある点です。IPx と IPy が論理名であったとしても、通常、ネットワーク全体の DNS エントリを変更するか、フラッシュする必要があります。ネットワーク テーブル内にキャッシュされているエントリも更新するか、フラッシュしなければなりません。そのため DNS インフラストラクチャの設定によってはダウンタイムが生じる可能性があります。こうした問題は、小さな TTL 値を使用するか (イントラネット アプリケーションの場合)、[Azure Traffic Manager と ASR](http://azure.microsoft.com/blog/2015/03/03/reduce-rto-by-using-azure-traffic-manager-with-azure-site-recovery/) を使用する (インターネット ベースのアプリケーションの場合) ことで軽減することができます。

### IP アドレスの変更 - 具体例

プライマリ サイトと復旧サイトとで異なる IP を使用する状況を考えてみます。次の例も、第 3 のサイトが存在し、そこからプライマリ サイトでホストされているアプリケーションまたは復旧サイトでホストされているアプリケーションにアクセスすることができます。

![Different IP - Before Failover](./media/site-recovery-network-design/network-design10.png)

図 11

図 11 では、一部のアプリケーションが、プライマリ サイトのサブネット 192.168.1.0/24 でホストされ、フェールオーバー後は復旧サイトのサブネット 172.16.1.0/24 でアップ状態になるように構成されています。VPN 接続/ネットワーク ルートは、3 つのサイトすべてが相互にアクセスできるように適切に構成されています。
 
アプリケーションは、フェールオーバーされた後、復旧サブネットで復元されます (図 12)。このケースでは、必ずしもサブネット全体を同時にフェールオーバーする必要はありません。VPN やネットワーク ルートを再構成するための変更は不要です。フェールオーバーと何回かの DNS 更新で、アプリケーションにアクセスできる状態が維持されます。動的更新を許可するように DNS が構成されている場合、仮想マシンは、フェールオーバー後に起動すると、新しい IP アドレスを使用して自身を登録します。

![Different IP - After Failover](./media/site-recovery-network-design/network-design11.png)

図 12

フェールオーバー後、レプリカ仮想マシンは、プライマリ仮想マシンの IP アドレスと異なる IP アドレスを保有する場合があります。仮想マシンは起動後に使用されている DNS サーバーを更新します。DNS エントリは、通常、ネットワーク全体で変更またはフラッシュする必要あります。ネットワーク テーブル内のキャッシュされたエントリも更新またはフラッシュする必要があります。したがって、これらの状態が変更が発生している間、ダウンタイムが発生するのは珍しいことではありません。この問題は以下の方法で軽減できます。

- イントラネット アプリケーションに低 TTL 値を使用する。
- インターネット ベースのアプリケーションには Azure Traffic Manger と ASR を使用する。
- タイムリーな更新を可能にするために、復旧計画で次のスクリプトを使用して DNS サーバーを更新する (動的 DNS 登録が構成されている場合、このスクリプトは必要ありません)。

		string]$Zone,
		[string]$name,
		[string]$IP
		)
		$Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
		$newrecord = $record.clone()
		$newrecord.RecordData[0].IPv4Address  =  $IP
		Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord


### IP アドレスの変更 (Azure への DR)

「[Networking Infrastructure Setup for Microsoft Azure as a Disaster Recovery Site (障害復旧サイトとして Microsoft Azure を使用するためのネットワーク インフラストラクチャのセットアップ)](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/)」ブログ投稿では、IP アドレスを維持することが要件になっていない場合に、必要な Azure ネットワーク インフラストラクチャをセットアップする方法について説明します。まず、アプリケーションについて説明したうえで、オンプレミスと Azure におけるネットワークの設定を紹介し、最後に、テスト フェールオーバーと計画フェールオーバーを実行する方法について取り上げています。



## 次のステップ

プライマリ サイトの管理に VMM サーバーを使用している場合の Site Recovery によるソース ネットワークとターゲット ネットワークのマッピングの詳細については、[こちらの記事](site-recovery-network-mapping.md)を参照してください。

<!---HONumber=AcomDC_0921_2016-->